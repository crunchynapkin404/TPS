{% extends 'base.html' %}

{% block title %}Calendar - {{ page_title }}{% endblock %}

{% block content %}
<div class="h-full flex flex-col bg-gray-50 dark:bg-gray-900">
    <!-- Calendar Header -->
    <div class="flex-shrink-0 bg-gradient-to-r from-tps-primary to-blue-700 text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">Team Planning Calendar</h1>
                    <p class="text-blue-100 mt-1">Unified calendar view with proper timezone handling</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="current-month-year">Loading...</div>
                    <div class="text-blue-100 text-sm">Current Period</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Controls -->
    <div class="flex-shrink-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 shadow-sm">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Team:</label>
                        <select id="teamSelect" class="form-input border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md">
                            <option value="">Loading teams...</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Month:</label>
                        <select id="monthSelect" class="form-input border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8" selected>August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Year:</label>
                        <select id="yearSelect" class="form-input border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="loadCalendar()" class="btn-primary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Load Calendar
                    </button>
                    <button onclick="loadTestData()" class="btn-secondary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Test Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Content -->
    <div class="flex-1 overflow-hidden">
        <div class="h-full max-w-7xl mx-auto p-6">
            
            <!-- Loading State -->
            <div id="loading" class="flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-tps-primary mx-auto mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">Loading calendar data...</p>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="error" class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg p-4 mb-6 hidden">
                <div class="flex">
                    <svg class="w-5 h-5 text-red-400 mr-3 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <p class="text-red-800 dark:text-red-200 font-medium">Error loading calendar data</p>
                        <p class="text-red-700 dark:text-red-300 text-sm mt-1">Please try again or contact support if the problem persists.</p>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Stats and Content -->
            <div id="calendar-content" class="hidden h-full flex flex-col">
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Shifts</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalEvents">0</p>
                            </div>
                            <div class="w-8 h-8 bg-tps-primary bg-opacity-20 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-tps-primary" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Waakdienst</p>
                                <p class="text-2xl font-bold text-amber-600" id="waakdienstEvents">0</p>
                            </div>
                            <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Incidents</p>
                                <p class="text-2xl font-bold text-green-600" id="incidentEvents">0</p>
                            </div>
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Sunday Shifts</p>
                                <p class="text-2xl font-bold text-purple-600" id="sundayEvents">0</p>
                            </div>
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calendar Grid -->
                <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="h-full flex flex-col">
                        <!-- Calendar Header -->
                        <div class="grid grid-cols-7 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                            <div class="p-3 text-center font-semibold text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-600">Monday</div>
                            <div class="p-3 text-center font-semibold text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-600">Tuesday</div>
                            <div class="p-3 text-center font-semibold text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-600">Wednesday</div>
                            <div class="p-3 text-center font-semibold text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-600">Thursday</div>
                            <div class="p-3 text-center font-semibold text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-600">Friday</div>
                            <div class="p-3 text-center font-semibold text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-600">Saturday</div>
                            <div class="p-3 text-center font-semibold text-gray-900 dark:text-gray-100">Sunday</div>
                        </div>
                        
                        <!-- Calendar Body -->
                        <div class="flex-1 overflow-auto">
                            <div id="calendar-grid" class="h-full">
                                <!-- Calendar cells will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Unified Calendar JavaScript
let currentTeamId = null;
let currentYear = 2025;
let currentMonth = 8;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTeams();
});

function loadTeams() {
    // For now, use mock team data since we don't have the API working
    const teamSelect = document.getElementById('teamSelect');
    teamSelect.innerHTML = '<option value="4">TPS Team (ID: 4)</option>';
    currentTeamId = 4;
    loadTestData();
}

function loadCalendar() {
    if (!currentTeamId) {
        showError('Please select a team first');
        return;
    }
    
    currentMonth = parseInt(document.getElementById('monthSelect').value);
    currentYear = parseInt(document.getElementById('yearSelect').value);
    
    showLoading();
    
    // Try to load from API first, fall back to test data
    const url = `/api/v1/teams/${currentTeamId}/calendar/month-fixed/?year=${currentYear}&month=${currentMonth}`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('API not available');
            }
            return response.json();
        })
        .then(data => {
            displayCalendar(data);
            hideLoading();
        })
        .catch(error => {
            console.warn('API loading failed, using test data:', error);
            loadTestData();
        });
}

function loadTestData() {
    // Generate comprehensive test data
    const testData = {
        month: currentMonth,
        year: currentYear,
        month_name: getMonthName(currentMonth),
        team: { id: currentTeamId, name: "TPS Team" },
        calendar_grid: generateCalendarGrid(currentYear, currentMonth),
        events: generateTestEvents(currentYear, currentMonth),
        total_events: 0
    };
    
    testData.total_events = testData.events.length;
    displayCalendar(testData);
    hideLoading();
}

function generateCalendarGrid(year, month) {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const startDate = new Date(firstDay);
    
    // Adjust to Monday start
    const dayOfWeek = (firstDay.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
    startDate.setDate(firstDay.getDate() - dayOfWeek);
    
    const grid = [];
    const currentDate = new Date(startDate);
    
    for (let week = 0; week < 6; week++) {
        const weekRow = [];
        for (let day = 0; day < 7; day++) {
            if (currentDate.getMonth() === month - 1) {
                weekRow.push(currentDate.getDate());
            } else {
                weekRow.push(0); // Other month
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        grid.push(weekRow);
        
        // Stop if we've covered all days of the month
        if (currentDate.getMonth() !== month - 1) {
            break;
        }
    }
    
    return grid;
}

function generateTestEvents(year, month) {
    const events = [];
    const users = ['User 01', 'User 02', 'User 03', 'User 04', 'User 05', 'User 06'];
    const templates = [
        { name: 'Waakdienst Coverage', type: 'waakdienst' },
        { name: 'Incident Planning', type: 'incident' },
        { name: 'Weekend Support', type: 'waakdienst' },
        { name: 'Emergency Response', type: 'incident' }
    ];
    
    let eventId = 1;
    
    // Generate events for the whole month
    for (let day = 1; day <= new Date(year, month, 0).getDate(); day++) {
        if (Math.random() > 0.3) { // 70% chance of having events on any day
            const numEvents = Math.floor(Math.random() * 3) + 1;
            
            for (let i = 0; i < numEvents; i++) {
                const user = users[Math.floor(Math.random() * users.length)];
                const template = templates[Math.floor(Math.random() * templates.length)];
                const startHour = Math.floor(Math.random() * 24);
                const duration = Math.floor(Math.random() * 8) + 1;
                
                events.push({
                    id: eventId++,
                    title: `${user} - ${template.name}`,
                    start: `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String(startHour).padStart(2, '0')}:00:00+02:00`,
                    end: `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String((startHour + duration) % 24).padStart(2, '0')}:00:00+02:00`,
                    user: { name: user },
                    shift: { template_name: template.name },
                    assignment_type: template.type
                });
            }
        }
    }
    
    return events;
}

function displayCalendar(data) {
    // Update header
    document.getElementById('current-month-year').textContent = `${data.month_name} ${data.year}`;
    
    // Calculate and display statistics
    const waakdienstCount = data.events.filter(e => e.assignment_type === 'waakdienst').length;
    const incidentCount = data.events.filter(e => e.assignment_type === 'incident').length;
    const sundayCount = data.events.filter(e => {
        const date = new Date(e.start);
        return date.getDay() === 0; // Sunday is 0
    }).length;
    
    document.getElementById('totalEvents').textContent = data.total_events;
    document.getElementById('waakdienstEvents').textContent = waakdienstCount;
    document.getElementById('incidentEvents').textContent = incidentCount;
    document.getElementById('sundayEvents').textContent = sundayCount;
    
    // Group events by date
    const eventsByDate = {};
    data.events.forEach(event => {
        const date = event.start.split('T')[0];
        if (!eventsByDate[date]) {
            eventsByDate[date] = [];
        }
        eventsByDate[date].push(event);
    });
    
    // Generate calendar grid
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    calendarGrid.className = 'grid grid-rows-' + data.calendar_grid.length + ' h-full';
    
    data.calendar_grid.forEach(week => {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'grid grid-cols-7 flex-1 border-b border-gray-200 dark:border-gray-600';
        
        week.forEach((day, dayIndex) => {
            const cell = document.createElement('div');
            cell.className = 'border-r border-gray-200 dark:border-gray-600 p-2 flex flex-col min-h-0';
            
            if (day === 0) {
                cell.className += ' bg-gray-50 dark:bg-gray-700';
            } else {
                const dateKey = `${data.year}-${String(data.month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Mark Sunday cells
                if (dayIndex === 6) {
                    cell.className += ' bg-amber-50 dark:bg-amber-900/20';
                }
                
                // Today highlighting
                const today = new Date();
                if (data.year === today.getFullYear() && 
                    data.month === today.getMonth() + 1 && 
                    day === today.getDate()) {
                    cell.className += ' bg-blue-50 dark:bg-blue-900/20 ring-2 ring-tps-primary';
                }
                
                // Date number
                const dateDiv = document.createElement('div');
                dateDiv.className = 'font-semibold text-gray-900 dark:text-gray-100 mb-1';
                dateDiv.textContent = day;
                cell.appendChild(dateDiv);
                
                // Events for this date
                if (eventsByDate[dateKey]) {
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'flex-1 space-y-1 overflow-y-auto';
                    
                    eventsByDate[dateKey].slice(0, 3).forEach(event => {
                        const eventDiv = document.createElement('div');
                        const colorClass = event.assignment_type === 'waakdienst' ? 
                            'bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 border-amber-200 dark:border-amber-700' :
                            'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border-green-200 dark:border-green-700';
                        
                        eventDiv.className = `text-xs p-1 rounded border ${colorClass}`;
                        
                        const startTime = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const endTime = new Date(event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        eventDiv.innerHTML = `
                            <div class="font-medium truncate">${event.user.name}</div>
                            <div class="text-xs opacity-75">${startTime}-${endTime}</div>
                        `;
                        
                        eventsContainer.appendChild(eventDiv);
                    });
                    
                    // Show "more" indicator if there are additional events
                    if (eventsByDate[dateKey].length > 3) {
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'text-xs text-gray-500 dark:text-gray-400 font-medium';
                        moreDiv.textContent = `+${eventsByDate[dateKey].length - 3} more`;
                        eventsContainer.appendChild(moreDiv);
                    }
                    
                    cell.appendChild(eventsContainer);
                }
            }
            
            weekDiv.appendChild(cell);
        });
        
        calendarGrid.appendChild(weekDiv);
    });
    
    document.getElementById('calendar-content').classList.remove('hidden');
}

function getMonthName(month) {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    return months[month - 1];
}

function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('error').classList.add('hidden');
    document.getElementById('calendar-content').classList.add('hidden');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
}

function showError(message) {
    document.getElementById('error').classList.remove('hidden');
    if (message) {
        document.querySelector('#error p').textContent = message;
    }
}</script>
{% endblock %}