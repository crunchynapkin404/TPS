{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- CSRF Token for API calls -->
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="h-full bg-white dark:bg-gray-800 overflow-hidden flex flex-col">
    <!-- Header with Month Navigation -->
    <div class="bg-gradient-to-br from-slate-800 to-slate-700 dark:from-slate-900 dark:to-slate-800 p-4 text-white flex justify-between items-center flex-wrap gap-4 flex-shrink-0">
        <div>
            <div class="text-2xl font-semibold">Team Schedule</div>
            <div class="flex gap-5 text-sm" id="calendar-stats">
                <div class="flex flex-col items-center">
                    <div class="text-lg font-bold" id="total-assignments">-</div>
                    <div class="text-gray-300">Assignments</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-lg font-bold" id="active-users">-</div>
                    <div class="text-gray-300">Active Users</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-lg font-bold" id="waakdienst-coverage">-</div>
                    <div class="text-xs uppercase tracking-wide text-gray-400">Waakdienst (7d)</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-lg font-bold" id="incident-coverage">-</div>
                    <div class="text-xs uppercase tracking-wide text-gray-400">Incident (5d)</div>
                </div>
            </div>
        </div>
        <div class="header-info">
            <div class="flex gap-3 items-center">
                <button class="bg-white/20 hover:bg-white/30 border-0 text-white px-3 py-2 rounded-md cursor-pointer transition-all duration-200 hover:scale-105 active:scale-95" onclick="changeMonth(-1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div class="font-semibold mx-3" id="current-month">
                    Loading...
                </div>
                <button class="bg-white/20 hover:bg-white/30 border-0 text-white px-3 py-2 rounded-md cursor-pointer transition-all duration-200 hover:scale-105 active:scale-95" onclick="changeMonth(1)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
                <button class="bg-white/20 hover:bg-white/30 border-0 text-white px-3 py-2 rounded-md cursor-pointer transition-all duration-200 hover:scale-105 active:scale-95" onclick="goToCurrentMonth()">
                    Today
                </button>
                <button class="bg-white/20 hover:bg-white/30 border-0 text-white px-3 py-2 rounded-md cursor-pointer transition-all duration-200 hover:scale-105 active:scale-95" onclick="changeMonth(1)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
                <button class="bg-white/20 hover:bg-white/30 border-0 text-white px-3 py-2 rounded-md cursor-pointer transition-all duration-200 hover:scale-105 active:scale-95" onclick="goToCurrentMonth()">
                    Today
                </button>
                <button class="bg-white/20 hover:bg-white/30 border-0 text-white px-3 py-2 rounded-md cursor-pointer transition-all duration-200 hover:scale-105 active:scale-95" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts">
                    <i class="fas fa-keyboard"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Calendar Grid Container -->
    <div class="flex-1 grid grid-cols-[240px_1fr] overflow-hidden min-h-0">
        <!-- Users Sidebar -->
        <div class="bg-gray-50 dark:bg-gray-700 border-r-2 border-gray-200 dark:border-gray-600 flex flex-col h-full">
            <div class="bg-gray-700 dark:bg-gray-800 text-white font-semibold text-center border-b-2 border-gray-600 dark:border-gray-500 text-base h-16 flex items-center justify-center flex-shrink-0">
                Team Members
            </div>
            <div class="flex-1 overflow-y-auto min-h-0" id="users-list">
                <div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading users...</div>
            </div>
        </div>
        
        <!-- Calendar Content -->
        <div class="flex flex-col overflow-hidden h-full min-h-0">
            <!-- Days Header -->
            <div class="bg-gray-700 dark:bg-gray-800 text-white h-16 flex-shrink-0 overflow-hidden">
                <div class="flex" id="days-header">
                    <div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading days...</div>
                </div>
            </div>
            
            <!-- Assignment Grid -->
            <div class="flex-1 overflow-auto min-h-0" id="assignments-grid-container">
                <div class="flex min-h-full" id="assignments-grid">
                    <div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading assignments...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assignment Detail Modal -->
<div id="assignment-modal" class="hidden">
    <!-- Will be populated by JavaScript -->
</div>

<!-- Bulk Actions Toolbar -->
<div class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 px-5 py-3 rounded-xl shadow-lg hidden z-[1001] gap-3 items-center" id="bulk-actions">
    <span class="text-sm">Selected: <span id="selection-count">0</span> items</span>
    <button class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all duration-200" onclick="bulkMoveAssignments()">Move</button>
    <button class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-all duration-200" onclick="bulkCopyAssignments()">Copy</button>
    <button class="px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all duration-200" onclick="bulkDeleteAssignments()">Delete</button>
    <button class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-all duration-200" onclick="clearSelection()">Clear</button>
</div>

<!-- Context Menu -->
<div class="fixed bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg py-2 z-[1000] min-w-[160px] hidden" id="context-menu">
    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer flex items-center gap-2" onclick="contextAction('view')">
        <i class="fas fa-eye"></i> View Details
    </div>
    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer flex items-center gap-2" onclick="contextAction('edit')">
        <i class="fas fa-edit"></i> Edit Assignment
    </div>
    <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer flex items-center gap-2" onclick="contextAction('copy')">
        <i class="fas fa-copy"></i> Copy Assignment
    </div>
    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer flex items-center gap-2" onclick="contextAction('move')">
        <i class="fas fa-arrows-alt"></i> Move Assignment
    </div>
    <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
    <div class="px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer flex items-center gap-2" onclick="contextAction('delete')">
        <i class="fas fa-trash"></i> Delete Assignment
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Clean Schedule JavaScript
let currentDate = new Date();
let currentTeamId = 4;
let calendarData = null;
let selectedAssignments = new Set();
let draggedAssignment = null;
let isMultiSelectMode = false;
let contextMenuTarget = null;

// Global date/time formatting functions for consistent EU format
function formatDate(date) {
    // DD/MM/YYYY format
    if (typeof date === 'string') {
        date = new Date(date);
    }
    return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function formatDateTime(date) {
    // DD/MM/YYYY HH:MM format (24-hour)
    if (typeof date === 'string') {
        date = new Date(date);
    }
    return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
}

function formatTime(date) {
    // HH:MM format (24-hour)
    if (typeof date === 'string') {
        date = new Date(date);
    }
    return date.toLocaleTimeString('en-GB', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
}

function formatDateLong(date) {
    // "Wednesday, 30 July 2025" format
    if (typeof date === 'string') {
        date = new Date(date);
    }
    return date.toLocaleDateString('en-GB', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function formatMonthName(date) {
    // "July" format
    if (typeof date === 'string') {
        date = new Date(date);
    }
    return date.toLocaleDateString('en-GB', { month: 'long' });
}

function getUserOptionsHTML(defaultUserId) {
    // Generate user selection options for assignment modal
    if (!calendarData || !calendarData.users) {
        return `<option value="${defaultUserId}">Loading users...</option>`;
    }
    
    let optionsHTML = '';
    calendarData.users.forEach(user => {
        const selected = user.id == defaultUserId ? 'selected' : '';
        optionsHTML += `<option value="${user.id}" ${selected}>${user.name}</option>`;
    });
    
    return optionsHTML;
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing calendar...');
    
    loadCalendarData();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    // Add window resize handler to maintain alignment
    window.addEventListener('resize', debounce(ensurePerfectAlignment, 250));
    
    // Synchronize horizontal scrolling between header and grid
    setupScrollSynchronization();
    
    // Add click outside to clear selection and hide context menu
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.assignment-block') && !e.target.closest('.bulk-actions')) {
            if (!e.ctrlKey && !e.metaKey) {
                clearSelection();
            }
        }
        
        // Hide context menu
        hideContextMenu();
    });
    
    // Prevent context menu on document
    document.addEventListener('contextmenu', function(e) {
        if (!e.target.closest('.assignment-block')) {
            hideContextMenu();
        }
    });
});

// Utility function to debounce resize events
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function setupScrollSynchronization() {
    const daysHeader = document.getElementById('days-header');
    const assignmentsGridContainer = document.getElementById('assignments-grid-container');
    
    if (!daysHeader || !assignmentsGridContainer) return;
    
    // Sync grid scroll to move header
    assignmentsGridContainer.addEventListener('scroll', function() {
        daysHeader.style.transform = `translateX(-${this.scrollLeft}px)`;
    });
}

async function loadCalendarData() {
    console.log('loadCalendarData called');
    try {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        
        console.log('Loading calendar for:', year, month);
        
        showNotification('Loading calendar...', 'info');
        
        // Get current date to determine starting point
        const today = new Date();
        const startDate = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        
        const response = await fetch(`/api/v1/calendar/${currentTeamId}/month/?year=${year}&month=${month}&start_date=${startDate}&extend_to_next_month=true`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        calendarData = await response.json();
        
        // Filter days to start from today if we're viewing current month
        if (year === today.getFullYear() && month === today.getMonth() + 1) {
            const todayString = today.toISOString().split('T')[0];
            calendarData.days = calendarData.days.filter(day => day.date >= todayString);
        }
        
        renderCalendar();
        
        if (calendarData.is_demo) {
            showNotification('Showing demo data', 'warning');
        } else {
            showNotification('Calendar loaded successfully!', 'success');
        }
        
    } catch (error) {
        console.error('Error loading calendar:', error);
        showNotification(`Error: ${error.message}`, 'error');
        
        // Show fallback content
        generateFallbackCalendar();
    }
}

function renderCalendar() {
    if (!calendarData) return;
    
    console.log('renderCalendar called with data:', calendarData);
    
    // Update month display
    let monthDisplay = `${calendarData.month_name} ${calendarData.year}`;
    
    // Check if we're showing next month days
    const hasNextMonthDays = calendarData.days.some(day => day.is_next_month);
    if (hasNextMonthDays) {
        const nextMonthDate = new Date(calendarData.year, calendarData.month, 1); // This will overflow to next month
        const nextMonthName = formatMonthName(nextMonthDate);
        const nextYear = nextMonthDate.getFullYear();
        
        if (nextYear !== calendarData.year) {
            monthDisplay += ` - ${nextMonthName} ${nextYear}`;
        } else {
            monthDisplay += ` - ${nextMonthName}`;
        }
    }
    
    document.getElementById('current-month').textContent = monthDisplay;
    
    // Calculate and update statistics
    updateCalendarStats();
    
    // Render users
    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '';
    
    console.log('Rendering users:', calendarData.users.length);
    
    // Calculate dynamic height based on number of users
    const userCount = calendarData.users.length;
    const availableHeight = 'calc(100vh - 200px)'; // Adjust based on header height
    
    calendarData.users.forEach(user => {
        const userRow = document.createElement('div');
        userRow.className = 'user-row flex items-center px-3 py-2 border-b border-gray-200 dark:border-gray-600 h-[60px] bg-white dark:bg-gray-800 flex-shrink-0';
        userRow.innerHTML = `
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${user.initials}</div>
            <div class="font-medium text-gray-900 dark:text-gray-100 truncate">${user.name}</div>
        `;
        usersList.appendChild(userRow);
    });
    
    // Render days header
    const daysHeader = document.getElementById('days-header');
    daysHeader.innerHTML = '';
    
    const today = new Date();
    const todayString = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
    
    calendarData.days.forEach(day => {
        const dayHeader = document.createElement('div');
        let classes = 'day-header w-32 flex-shrink-0 text-center font-semibold border-r-2 border-gray-600 dark:border-gray-500 h-16 flex flex-col items-center justify-center text-sm';
        if (day.is_weekend) classes += ' bg-gray-600 dark:bg-gray-700';
        if (day.date === todayString) classes += ' bg-blue-600 dark:bg-blue-700';
        if (day.is_next_month) classes += ' opacity-60';
        
        dayHeader.className = classes;
        dayHeader.innerHTML = `
            <div class="day-name">${day.day_name}</div>
            <div class="day-number">${day.day_number}</div>
        `;
        daysHeader.appendChild(dayHeader);
    });
    
    // Render assignments grid
    const assignmentsGrid = document.getElementById('assignments-grid');
    assignmentsGrid.innerHTML = '';
    
    console.log('Rendering assignments grid for days:', calendarData.days.length);
    
    // Create columns for each day
    calendarData.days.forEach(day => {
        const dayColumn = document.createElement('div');
        let classes = 'w-32 flex-shrink-0 border-r border-gray-200 dark:border-gray-600 flex flex-col';
        if (day.is_weekend) classes += ' bg-gray-50 dark:bg-gray-750';
        if (day.date === todayString) classes += ' bg-blue-50 dark:bg-blue-900/20';
        if (day.is_next_month) classes += ' opacity-60';
        
        dayColumn.className = classes;
        
        // Create cells for each user - they will automatically align with user rows
        calendarData.users.forEach(user => {
            const cell = document.createElement('div');
            cell.className = 'assignment-cell relative border-b border-gray-200 dark:border-gray-600 p-1 h-[60px] flex flex-col gap-1 overflow-hidden hover:bg-gray-50 dark:hover:bg-gray-700 flex-shrink-0';
            cell.dataset.userId = user.id;
            cell.dataset.date = day.date;
            cell.dataset.userName = user.name;
            
            // Add assignments for this user on this day
            const userAssignments = user.assignments[day.date] || [];
            
            // Check for Waakdienst consolidation - same user, same day, multiple Waakdienst shifts
            const waakdienstShifts = userAssignments.filter(a => a.type.toLowerCase() === 'waakdienst');
            const otherShifts = userAssignments.filter(a => a.type.toLowerCase() !== 'waakdienst');
            
            let assignmentsToRender = [];
            
            // Handle Waakdienst consolidation
            if (waakdienstShifts.length > 1) {
                // Create consolidated Waakdienst block
                const consolidatedShift = {
                    id: `consolidated-${waakdienstShifts.map(s => s.id).join('-')}`,
                    type: 'Waakdienst',
                    start_time: waakdienstShifts[0].start_time,
                    end_time: waakdienstShifts[waakdienstShifts.length - 1].end_time,
                    isConsolidated: true,
                    individualShifts: waakdienstShifts
                };
                assignmentsToRender.push(consolidatedShift);
                
                // Add other non-Waakdienst shifts
                assignmentsToRender = assignmentsToRender.concat(otherShifts);
            } else {
                // No consolidation needed, use all assignments as-is
                assignmentsToRender = userAssignments;
            }
            
            // Mark cell if it has multiple assignments (after consolidation)
            if (assignmentsToRender.length > 3) {
                cell.classList.add('has-multiple');
            }
            
            // Mark cell if it has any assignments
            if (assignmentsToRender.length > 0) {
                cell.classList.add('has-assignments');
            }
            
            // Show only first 3 assignments (with consolidation applied)
            const visibleAssignments = assignmentsToRender.slice(0, 3);
            visibleAssignments.forEach(assignment => {
                const assignmentBlock = document.createElement('div');
                
                if (assignment.isConsolidated) {
                    // Consolidated Waakdienst block
                    assignmentBlock.className = 'text-xs px-2 py-1 rounded text-white cursor-pointer truncate font-medium shadow-sm hover:shadow-md transition-all duration-200 bg-blue-600 hover:bg-blue-700';
                    assignmentBlock.title = `üõ°Ô∏è Waakdienst (${assignment.individualShifts.length} shifts) ${assignment.start_time}-${assignment.end_time}`;
                    assignmentBlock.draggable = true;
                    
                    // Store individual shift data for potential splitting
                    assignmentBlock.dataset.isConsolidated = 'true';
                    assignmentBlock.dataset.individualShifts = JSON.stringify(assignment.individualShifts);
                    assignmentBlock.dataset.assignmentId = assignment.individualShifts[0].id; // Use first shift ID for drag operations
                    assignmentBlock.dataset.userId = user.id;
                    assignmentBlock.dataset.date = day.date;
                    
                    assignmentBlock.innerHTML = `
                        <div class="assignment-type">üõ°Ô∏è Waakdienst</div>
                    `;
                } else {
                    // Regular individual assignment
                    const typeColors = {
                        'waakdienst': 'bg-blue-600 hover:bg-blue-700',
                        'incident': 'bg-red-600 hover:bg-red-700',
                        'standby': 'bg-green-600 hover:bg-green-700',
                        'training': 'bg-purple-600 hover:bg-purple-700',
                        'meeting': 'bg-amber-600 hover:bg-amber-700',
                        'leave': 'bg-gray-600 hover:bg-gray-700',
                        'other': 'bg-indigo-600 hover:bg-indigo-700'
                    };
                    const colorClass = typeColors[assignment.type.toLowerCase()] || 'bg-indigo-600 hover:bg-indigo-700';
                    assignmentBlock.className = `text-xs px-2 py-1 rounded text-white cursor-pointer truncate font-medium shadow-sm hover:shadow-md transition-all duration-200 ${colorClass}`;
                    assignmentBlock.title = `${assignment.type} ${assignment.start_time}-${assignment.end_time}`;
                    assignmentBlock.draggable = true;
                    assignmentBlock.dataset.assignmentId = assignment.id;
                    assignmentBlock.dataset.userId = user.id;
                    assignmentBlock.dataset.date = day.date;
                    assignmentBlock.innerHTML = `
                        <div class="assignment-type">${assignment.type}</div>
                    `;
                }
                
                // Add drag and drop event listeners
                assignmentBlock.addEventListener('dragstart', handleDragStart);
                assignmentBlock.addEventListener('dragend', handleDragEnd);
                
                // Add click handler for selection
                assignmentBlock.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (e.ctrlKey || e.metaKey) {
                        toggleAssignmentSelection(assignmentBlock);
                    } else if (e.detail === 2) { // Double click
                        if (assignment.isConsolidated) {
                            showConsolidatedAssignmentDetails(assignment, user, day);
                        } else {
                            showAssignmentDetails(assignment, user, day);
                        }
                    } else {
                        if (selectedAssignments.size === 0) {
                            if (assignment.isConsolidated) {
                                showConsolidatedAssignmentDetails(assignment, user, day);
                            } else {
                                showAssignmentDetails(assignment, user, day);
                            }
                        } else {
                            toggleAssignmentSelection(assignmentBlock);
                        }
                    }
                });
                
                // Add right-click context menu
                assignmentBlock.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    contextMenuTarget = { assignment, user, day, element: assignmentBlock };
                    showContextMenu(e.pageX, e.pageY);
                });
                
                cell.appendChild(assignmentBlock);
            });
            
            // Add overflow indicator if there are more than 3 assignments (after consolidation)
            if (assignmentsToRender.length > 3) {
                const extraCount = assignmentsToRender.length - 3;
                const overflowDiv = document.createElement('div');
                overflowDiv.className = 'assignment-overflow';
                overflowDiv.textContent = `+${extraCount}`;
                
                // Add tooltip with all assignments
                const tooltip = document.createElement('div');
                tooltip.className = 'assignment-tooltip';
                const allAssignments = assignmentsToRender.map(a => {
                    if (a.isConsolidated) {
                        return `üõ°Ô∏è Waakdienst (${a.individualShifts.length} shifts) ${a.start_time}-${a.end_time}`;
                    } else {
                        return `${a.type} ${a.start_time}-${a.end_time}`;
                    }
                }).join('\n');
                tooltip.textContent = allAssignments;
                
                cell.appendChild(overflowDiv);
                cell.appendChild(tooltip);
            }
            
            // Add click handler for ALL cells (both empty and with assignments)
            cell.addEventListener('click', (e) => {
                // Priority order: assignment blocks > quick-create overlay > empty cell
                if (e.target.classList.contains('assignment-block') || e.target.closest('.assignment-block')) {
                    // Assignment block click - let the assignment block handler manage this
                    return;
                } else if (e.target.classList.contains('quick-create-overlay')) {
                    // Quick create overlay clicked
                    e.stopPropagation();
                    showQuickAssign(user, day);
                } else if (e.target === cell) {
                    // Empty cell clicked - only trigger if no assignments or overlay
                    if (!cell.classList.contains('has-assignments')) {
                        showQuickAssign(user, day);
                    }
                }
            });
            
            // Add quick create overlay for ALL cells
            const overlay = document.createElement('div');
            overlay.className = 'quick-create-overlay';
            overlay.textContent = '+';
            overlay.title = 'Add Assignment';
            cell.appendChild(overlay);
            
            // Add drop zone functionality
            cell.addEventListener('dragover', handleDragOver);
            cell.addEventListener('drop', handleDrop);
            cell.addEventListener('dragenter', handleDragEnter);
            cell.addEventListener('dragleave', handleDragLeave);
            
            dayColumn.appendChild(cell);
        });
        
        assignmentsGrid.appendChild(dayColumn);
    });
    
    // Ensure perfect alignment between sidebar and calendar grid
    ensurePerfectAlignment();
    
    // Set up scroll synchronization after DOM is ready
    setupScrollSynchronization();
}

function ensurePerfectAlignment() {
    // With the new CSS layout using fixed heights (h-[60px]) and flex-shrink-0,
    // the alignment should be automatic. This function now just ensures
    // scroll synchronization is working properly.
    setTimeout(() => {
        setupScrollSynchronization();
    }, 100);
}

function generateFallbackCalendar() {
    document.getElementById('current-month').textContent = 'Schedule (Demo Mode)';
    
    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '<div class="user-row"><div class="user-name">Demo mode - API not available</div></div>';
    
    const daysHeader = document.getElementById('days-header');
    daysHeader.innerHTML = '<div class="day-header"><div class="day-name">Demo</div></div>';
    
    const assignmentsGrid = document.getElementById('assignments-grid');
    assignmentsGrid.innerHTML = '<div class="day-column"><div class="assignment-cell">No data available</div></div>';
    
    // Try to maintain alignment even in fallback mode
    ensurePerfectAlignment();
}

function changeMonth(offset) {
    currentDate.setMonth(currentDate.getMonth() + offset);
    loadCalendarData();
}

function goToCurrentMonth() {
    currentDate = new Date();
    loadCalendarData();
}

async function deleteAssignment(assignmentId) {
    if (!confirm('Are you sure you want to delete this assignment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/assignments/${assignmentId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
        });
        
        if (response.ok) {
            // Close the modal
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
            
            // Reload the calendar data to reflect the deletion
            loadCalendarData();
            
            // Show success message
            showNotification('Assignment deleted successfully', 'success');
        } else {
            throw new Error('Failed to delete assignment');
        }
    } catch (error) {
        console.error('Error deleting assignment:', error);
        showNotification('Failed to delete assignment', 'error');
    }
}

function showAssignmentDetails(assignment, user, day) {
    const modal = `
        <div class="fixed inset-0 bg-black/50 z-[999] flex items-center justify-center" onclick="closeModal(this)">
            <div onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl min-w-[350px] max-w-[500px] text-gray-900 dark:text-gray-100">
                <h3 class="text-xl font-semibold mb-4">Assignment Details</h3>
                <div class="my-3"><strong>User:</strong> ${user.name}</div>
                <div class="my-3"><strong>Date:</strong> ${formatDate(day.date)}</div>
                <div class="my-3"><strong>Time:</strong> ${assignment.start_time} - ${assignment.end_time}</div>
                <div class="my-3"><strong>Type:</strong> ${assignment.type}</div>
                <div class="my-3"><strong>Status:</strong> ${assignment.status}</div>
                <div class="mt-5 flex gap-2 justify-end">
                    <button onclick="deleteAssignment(${assignment.id})" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white border-0 rounded-md cursor-pointer transition-colors">
                        Delete
                    </button>
                    <button onclick="closeModal(this.closest('.fixed'))" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white border-0 rounded-md cursor-pointer transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modal;
    document.body.appendChild(modalContainer);
}

function showConsolidatedAssignmentDetails(consolidatedAssignment, user, day) {
    const shiftsHTML = consolidatedAssignment.individualShifts.map(shift => `
        <div class="my-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-md">
            <strong>Shift ${shift.id}:</strong> ${shift.start_time} - ${shift.end_time}
            ${shift.status ? `<br><small>Status: ${shift.status}</small>` : ''}
        </div>
    `).join('');
    
    const modal = `
        <div class="fixed inset-0 bg-black/50 z-[999] flex items-center justify-center" onclick="closeModal(this)">
            <div onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg text-gray-900 dark:text-gray-100">
                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üõ°Ô∏è Consolidated Waakdienst Details
                </h3>
                <div class="my-3"><strong>User:</strong> ${user.name}</div>
                <div class="my-3"><strong>Date:</strong> ${formatDate(day.date)}</div>
                <div class="my-3"><strong>Total Coverage:</strong> ${consolidatedAssignment.start_time} - ${consolidatedAssignment.end_time}</div>
                <div class="my-4">
                    <strong>Individual Shifts (${consolidatedAssignment.individualShifts.length}):</strong>
                    ${shiftsHTML}
                </div>
                <div class="mt-5 p-3 bg-amber-100 dark:bg-amber-900/20 rounded-md border-l-4 border-amber-500">
                    <small class="text-amber-800 dark:text-amber-200"><strong>Note:</strong> This is a consolidated view. You can still drag individual shifts separately when needed.</small>
                </div>
                <div class="mt-5 flex gap-2 justify-end">
                    <button onclick="closeModal(this.closest('.fixed'))" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white border-0 rounded-md cursor-pointer transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modal;
    document.body.appendChild(modalContainer);
}

function showQuickAssign(user, day) {
    // Load assignment types and show modal
    loadAssignmentTypesAndShowModal(user, day);
}

async function loadAssignmentTypesAndShowModal(user, day) {
    try {
        // Load available assignment types
        const response = await fetch('/api/v1/assignments/types/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        let assignmentTypes = [];
        if (response.ok) {
            const result = await response.json();
            assignmentTypes = result.assignment_types;
        } else {
            // Fallback to default types
            assignmentTypes = [
                { value: 'waakdienst', label: 'üõ°Ô∏è Waakdienst', default_duration: 8 },
                { value: 'incident', label: 'üö® Incident Response', default_duration: 4 },
                { value: 'changes', label: '‚öôÔ∏è Change Management', default_duration: 6 },
                { value: 'maintenance', label: 'üîß Maintenance', default_duration: 4 }
            ];
        }
        
        // Generate options HTML
        const optionsHTML = assignmentTypes.map(type => 
            `<option value="${type.value}" data-duration="${type.default_duration || 8}">${type.label}</option>`
        ).join('');
        
        const modal = `
            <div class="fixed inset-0 bg-black/50 z-[999] flex items-center justify-center" onclick="closeModal(this)">
                <div onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl min-w-[400px] max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
                        Quick Assign - ${user.name}
                    </h3>
                    <div class="my-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
                        <strong>Date:</strong> ${formatDate(day.date)}
                    </div>
                    <div class="my-4">
                        <label class="block mb-2 font-medium text-gray-900 dark:text-gray-100">Assignment Type:</label>
                        <select id="assignment-type" onchange="updateDefaultTimes()" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            ${optionsHTML}
                        </select>
                    </div>
                    <div class="my-4">
                        <label class="block mb-2 font-medium text-gray-900 dark:text-gray-100">Assign To:</label>
                        <select id="assign-to-user" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            ${getUserOptionsHTML(user.id)}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3 my-4">
                        <div>
                            <label class="block mb-1.5 font-medium text-gray-900 dark:text-gray-100">Start Time (24h):</label>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <select id="start-hour" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    ${Array.from({length: 24}, (_, i) => `<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`).join('')}
                                </select>
                                <span class="font-bold text-center text-gray-900 dark:text-gray-100">:</span>
                                <select id="start-minute" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block mb-1.5 font-medium text-gray-900 dark:text-gray-100">End Time (24h):</label>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <select id="end-hour" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    ${Array.from({length: 24}, (_, i) => `<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`).join('')}
                                </select>
                                <span class="font-bold text-center text-gray-900 dark:text-gray-100">:</span>
                                <select id="end-minute" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="my-4">
                        <label class="block mb-1.5 font-medium text-gray-900 dark:text-gray-100">Notes (optional):</label>
                        <textarea id="assignment-notes" placeholder="Add any additional notes..." 
                                 class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md min-h-[60px] resize-vertical bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></textarea>
                    </div>
                    <div id="conflict-warning" class="hidden my-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md text-red-900 dark:text-red-200">
                        <strong>‚ö†Ô∏è Time Conflict:</strong> <span id="conflict-message"></span>
                    </div>
                    <div class="mt-6 flex gap-2 justify-end">
                        <button onclick="validateAndCreateWithClose('${user.id}', '${day.date}');" 
                                class="px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white border-0 rounded-md cursor-pointer font-medium transition-colors">
                            Create Assignment
                        </button>
                        <button onclick="closeModal(this.closest('.fixed'))" 
                                class="px-5 py-2.5 bg-gray-600 hover:bg-gray-700 text-white border-0 rounded-md cursor-pointer transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modal;
        document.body.appendChild(modalContainer);
        
        // Set initial default times
        updateDefaultTimes();
        
    } catch (error) {
        console.error('Error loading assignment types:', error);
        // Show basic modal without dynamic types
        showBasicQuickAssign(user, day);
    }
}

function updateDefaultTimes() {
    const select = document.getElementById('assignment-type');
    const startHourSelect = document.getElementById('start-hour');
    const startMinuteSelect = document.getElementById('start-minute');
    const endHourSelect = document.getElementById('end-hour');
    const endMinuteSelect = document.getElementById('end-minute');
    
    if (select && startHourSelect && startMinuteSelect && endHourSelect && endMinuteSelect) {
        const selectedOption = select.options[select.selectedIndex];
        const duration = parseInt(selectedOption.dataset.duration) || 8;
        
        // Set default times based on assignment type
        const assignmentType = select.value;
        let startTime = '14:00';  // 2 PM in 24h format
        let endTime = '18:00';    // 6 PM in 24h format
        
        switch (assignmentType) {
            case 'waakdienst':
                startTime = '17:00';  // 5 PM
                endTime = '09:00';    // 9 AM next day
                break;
            case 'incident':
                startTime = '08:00';  // 8 AM
                endTime = String(8 + duration).padStart(2, '0') + ':00';
                break;
            case 'changes':
                startTime = '22:00';  // 10 PM
                endTime = String(22 + duration).padStart(2, '0') + ':00';
                break;
            case 'maintenance':
                startTime = '06:00';
                endTime = String(6 + duration).padStart(2, '0') + ':00';
                break;
        }
        
        // Set the dropdown values
        const [startHour, startMinute] = startTime.split(':');
        const [endHour, endMinute] = endTime.split(':');
        
        startHourSelect.value = startHour;
        startMinuteSelect.value = startMinute;
        endHourSelect.value = endHour;
        endMinuteSelect.value = endMinute;
    }
}

function showBasicQuickAssign(user, day) {
    const modal = `
        <div class="fixed inset-0 bg-black/50 z-[999] flex items-center justify-center" onclick="closeModal(this)">
            <div onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl min-w-[400px]">
                <h3 class="mb-4 text-gray-900 dark:text-gray-100 text-lg font-semibold">
                    Quick Assign - ${user.name}
                </h3>
                <div class="my-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
                    <strong>Date:</strong> ${formatDate(day.date)}
                </div>
                <div class="my-4">
                    <label class="block mb-2 font-medium text-gray-900 dark:text-gray-100">Assignment Type:</label>
                    <select id="assignment-type" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="waakdienst">üõ°Ô∏è Waakdienst</option>
                        <option value="incident">üö® Incident Response</option>
                        <option value="changes">‚öôÔ∏è Change Management</option>
                        <option value="maintenance">üîß Maintenance</option>
                    </select>
                </div>
                <div class="my-4">
                    <label class="block mb-2 font-medium text-gray-900 dark:text-gray-100">Assign To:</label>
                    <select id="assign-to-user" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        ${getUserOptionsHTML(user.id)}
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3 my-4">
                    <div>
                        <label class="block mb-1.5 font-medium text-gray-900 dark:text-gray-100">Start Time (24h):</label>
                        <div class="grid grid-cols-3 gap-1 items-center">
                            <select id="start-hour" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                ${Array.from({length: 24}, (_, i) => `<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`).join('')}
                            </select>
                            <span class="font-bold text-center text-gray-900 dark:text-gray-100">:</span>
                            <select id="start-minute" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                <option value="00">00</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1.5 font-medium text-gray-900 dark:text-gray-100">End Time (24h):</label>
                        <div class="grid grid-cols-3 gap-1 items-center">
                            <select id="end-hour" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                ${Array.from({length: 24}, (_, i) => `<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`).join('')}
                            </select>
                            <span class="font-bold text-center text-gray-900 dark:text-gray-100">:</span>
                            <select id="end-minute" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                <option value="00">00</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex gap-2 justify-end">
                    <button onclick="createQuickAssignmentWithClose('${user.id}', '${day.date}');" 
                            class="px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white border-0 rounded-md cursor-pointer font-medium transition-colors">
                        Create Assignment
                    </button>
                    <button onclick="closeModal(this.closest('.fixed'))" 
                            class="px-5 py-2.5 bg-gray-600 hover:bg-gray-700 text-white border-0 rounded-md cursor-pointer transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modal;
    document.body.appendChild(modalContainer);
    
    // Set default time values (14:00 - 18:00)
    document.getElementById('start-hour').value = '14';
    document.getElementById('start-minute').value = '00';
    document.getElementById('end-hour').value = '18';
    document.getElementById('end-minute').value = '00';
}

async function validateAndCreate(userId, date) {
    const type = document.getElementById('assignment-type').value;
    
    // Get time values from dropdowns
    const startHour = document.getElementById('start-hour').value;
    const startMinute = document.getElementById('start-minute').value;
    const endHour = document.getElementById('end-hour').value;
    const endMinute = document.getElementById('end-minute').value;
    
    const startTime = `${startHour}:${startMinute}`;
    const endTime = `${endHour}:${endMinute}`;
    
    const notes = document.getElementById('assignment-notes').value;
    
    // Validate time slot first
    try {
        const response = await fetch('/api/v1/assignments/validate-slot/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                user_id: parseInt(userId),
                date: date,
                start_time: startTime,
                end_time: endTime
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.valid) {
                // No conflicts, proceed with creation
                createAssignmentAPI(userId, date, type, startTime, endTime, notes);
            } else {
                // Show conflict warning
                const warning = document.getElementById('conflict-warning');
                const message = document.getElementById('conflict-message');
                if (warning && message) {
                    message.textContent = result.message;
                    warning.classList.remove('hidden');
                    warning.classList.add('block');
                    
                    // Ask user if they want to proceed anyway
                    setTimeout(() => {
                        if (confirm(`${result.message}\n\nDo you want to create the assignment anyway?`)) {
                            createAssignmentAPI(userId, date, type, startTime, endTime, notes);
                        }
                    }, 100);
                }
            }
        } else {
            // Validation failed, proceed anyway
            createAssignmentAPI(userId, date, type, startTime, endTime, notes);
        }
    } catch (error) {
        console.error('Validation error:', error);
        // Proceed with creation despite validation error
        createAssignmentAPI(userId, date, type, startTime, endTime, notes);
    }
}

function createQuickAssignment(userId, date) {
    const type = document.getElementById('assignment-type').value;
    
    // Get time values from dropdowns
    const startHour = document.getElementById('start-hour').value;
    const startMinute = document.getElementById('start-minute').value;
    const endHour = document.getElementById('end-hour').value;
    const endMinute = document.getElementById('end-minute').value;
    
    const startTime = `${startHour}:${startMinute}`;
    const endTime = `${endHour}:${endMinute}`;
    
    const notes = document.getElementById('assignment-notes').value;
    
    showNotification(`Creating ${type} assignment for ${date} (${startTime}-${endTime})`, 'info');
    
    // Make actual API call to create the assignment
    createAssignmentAPI(userId, date, type, startTime, endTime, notes);
}

async function createAssignmentAPI(userId, date, type, startTime, endTime, notes) {
    try {
        const response = await fetch('/api/v1/assignments/quick-create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                user_id: parseInt(userId),
                date: date,
                assignment_type: type,
                start_time: startTime,
                end_time: endTime,
                notes: notes,
                team_id: currentTeamId
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification('Assignment created successfully!', 'success');
            loadCalendarData(); // Refresh calendar to show new assignment
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create assignment');
        }
        
    } catch (error) {
        console.error('Error creating assignment:', error);
        showNotification(`Error: ${error.message}`, 'error');
    }
}

function showKeyboardShortcuts() {
    const modal = `
        <div onclick="this.remove()" class="fixed inset-0 bg-black/50 z-[999]"></div>
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
                    bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl
                    z-[1000] min-w-[500px] max-w-[600px]">
            <h3 class="mb-5 text-gray-900 dark:text-gray-100 text-xl font-semibold flex items-center gap-2.5">
                <i class="fas fa-keyboard text-blue-500"></i>
                Keyboard Shortcuts & Features
            </h3>
            
            <div class="grid grid-cols-2 gap-5 mb-5">
                <div>
                    <h4 class="mb-3 text-gray-700 dark:text-gray-300 text-sm font-semibold">Selection</h4>
                    <div class="space-y-2">
                        <div class="mb-2"><kbd class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs">Ctrl+A</kbd> Select all assignments</div>
                        <div class="mb-2"><kbd class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs">Ctrl+Click</kbd> Multi-select assignments</div>
                        <div class="mb-2"><kbd class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs">Esc</kbd> Clear selection</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="mb-3 text-gray-700 dark:text-gray-300 text-sm font-semibold">Actions</h4>
                    <div class="space-y-2">
                        <div class="mb-2"><kbd class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs">Delete</kbd> Delete selected assignments</div>
                        <div class="mb-2"><kbd class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs">Double-click</kbd> View assignment details</div>
                        <div class="mb-2"><strong>Drag & Drop</strong> Move assignments</div>
                    </div>
                </div>
            </div>
            
            <div class="mb-5">
                <h4 class="mb-3 text-gray-700 dark:text-gray-300 text-sm font-semibold">Features</h4>
                <ul class="ml-5 text-gray-600 dark:text-gray-400 text-sm leading-relaxed space-y-1">
                    <li><strong>Drag & Drop:</strong> Drag assignments between users and dates</li>
                    <li><strong>Multi-Select:</strong> Hold Ctrl/Cmd and click to select multiple assignments</li>
                    <li><strong>Bulk Operations:</strong> Move, copy, or delete multiple assignments at once</li>
                    <li><strong>Quick Create:</strong> Click empty cells to quickly create assignments</li>
                    <li><strong>Visual Indicators:</strong> Weekend highlighting, current day marking, next month styling</li>
                    <li><strong>Smart Calendar:</strong> Starts from today and extends into next month seamlessly</li>
                </ul>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="this.closest('div').parentNode.remove()" 
                        class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white border-0 rounded-md cursor-pointer font-medium transition-colors">
                    Got it!
                </button>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modal;
    document.body.appendChild(modalContainer);
}

function showNotification(message, type = 'info') {
    console.log(`Notification (${type}):`, message);
    // Temporarily just log to console instead of creating DOM elements
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// Modal management functions
function closeModal(modalElement) {
    if (modalElement) {
        modalElement.remove();
    }
}

function validateAndCreateWithClose(originalUserId, date) {
    // Get the selected user from the dropdown, fallback to original user
    const selectedUserId = document.getElementById('assign-to-user')?.value || originalUserId;
    validateAndCreate(selectedUserId, date);
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

function createQuickAssignmentWithClose(originalUserId, date) {
    // Get the selected user from the dropdown, fallback to original user  
    const selectedUserId = document.getElementById('assign-to-user')?.value || originalUserId;
    createQuickAssignment(selectedUserId, date);
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Drag and Drop Functions
function handleDragStart(e) {
    const element = e.target;
    
    // Check if this is a consolidated assignment
    if (element.dataset.isConsolidated === 'true') {
        // For consolidated assignments, we need to let user choose which shift to move
        e.preventDefault();
        showConsolidatedShiftSelector(element);
        return;
    }
    
    draggedAssignment = {
        element: element,
        assignmentId: element.dataset.assignmentId,
        userId: element.dataset.userId,
        date: element.dataset.date
    };
    element.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', element.outerHTML);
}

function showConsolidatedShiftSelector(consolidatedElement) {
    const individualShifts = JSON.parse(consolidatedElement.dataset.individualShifts);
    const userName = consolidatedElement.dataset.userName || 'User';
    const date = consolidatedElement.dataset.date;
    
    const shiftsHTML = individualShifts.map(shift => `
        <button onclick="selectShiftForDrag('${shift.id}', '${consolidatedElement.dataset.userId}', '${date}', this.closest('.fixed'))" 
                class="block w-full my-2 p-3 bg-white border-2 border-gray-200 rounded-md cursor-pointer text-left transition-all hover:border-blue-500 hover:bg-blue-50 dark:bg-gray-700 dark:border-gray-600 dark:hover:border-blue-400 dark:hover:bg-blue-900/20">
            <strong>Shift ${shift.id}</strong><br>
            <small>${shift.start_time} - ${shift.end_time}</small>
        </button>
    `).join('');
    
    const modal = `
        <div class="fixed inset-0 bg-black/50 z-[999] flex items-center justify-center" onclick="closeModal(this)">
            <div onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl min-w-[350px] max-w-[400px]">
                <h3 class="mb-4 text-gray-900 dark:text-gray-100 text-lg font-semibold flex items-center gap-2">
                    üõ°Ô∏è Select Shift to Move
                </h3>
                <p class="mb-4 text-gray-600 dark:text-gray-400">Choose which Waakdienst shift you want to move:</p>
                ${shiftsHTML}
                <div class="mt-5 flex gap-2 justify-end">
                    <button onclick="closeModal(this.closest('.fixed'))" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white border-0 rounded-md cursor-pointer transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modal;
    document.body.appendChild(modalContainer);
}

function selectShiftForDrag(shiftId, userId, date, modalElement) {
    // Close the modal
    if (modalElement) {
        modalElement.remove();
    }
    
    // Enable drag mode for the selected shift
    draggedAssignment = {
        element: null, // Will be set when drag actually starts
        assignmentId: shiftId,
        userId: userId,
        date: date,
        isFromConsolidated: true
    };
    
    // Show a notification and enable drop zones
    showNotification(`Selected shift ${shiftId} for moving. Click on target cell to move.`, 'info');
    
    // Add visual indicators for drop zones
    document.querySelectorAll('.assignment-cell').forEach(cell => {
        if (cell.dataset.userId !== userId || cell.dataset.date !== date) {
            cell.classList.add('border-2', 'border-dashed', 'border-blue-500', 'opacity-70');
            cell.addEventListener('click', handleConsolidatedShiftDrop);
        }
    });
    
    // Add cancel option
    document.addEventListener('keydown', cancelConsolidatedDrag);
}

function handleConsolidatedShiftDrop(e) {
    if (!draggedAssignment || !draggedAssignment.isFromConsolidated) return;
    
    const targetUserId = e.target.dataset.userId;
    const targetDate = e.target.dataset.date;
    
    if (targetUserId && targetDate) {
        moveAssignment(draggedAssignment.assignmentId, targetUserId, targetDate);
        cleanupConsolidatedDrag();
    }
}

function cancelConsolidatedDrag(e) {
    if (e.key === 'Escape') {
        cleanupConsolidatedDrag();
        showNotification('Move cancelled', 'info');
    }
}

function cleanupConsolidatedDrag() {
    // Remove visual indicators
    document.querySelectorAll('.assignment-cell').forEach(cell => {
        cell.classList.remove('border-2', 'border-dashed', 'border-blue-500', 'opacity-70');
        cell.removeEventListener('click', handleConsolidatedShiftDrop);
    });
    
    // Remove event listeners
    document.removeEventListener('keydown', cancelConsolidatedDrag);
    
    // Clear drag state
    draggedAssignment = null;
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedAssignment = null;
    
    // Clean up all drag-over classes
    document.querySelectorAll('.assignment-cell').forEach(cell => {
        cell.classList.remove('drag-over', 'drag-invalid');
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    e.preventDefault();
    if (draggedAssignment && e.target.classList.contains('assignment-cell')) {
        // Check if this is a valid drop target
        const targetUserId = e.target.dataset.userId;
        const targetDate = e.target.dataset.date;
        
        if (targetUserId !== draggedAssignment.userId || targetDate !== draggedAssignment.date) {
            e.target.classList.add('drag-over');
        } else {
            e.target.classList.add('drag-invalid');
        }
    }
}

function handleDragLeave(e) {
    if (!e.target.contains(e.relatedTarget)) {
        e.target.classList.remove('drag-over', 'drag-invalid');
    }
}

function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over', 'drag-invalid');
    
    if (draggedAssignment && e.target.classList.contains('assignment-cell')) {
        const targetUserId = e.target.dataset.userId;
        const targetDate = e.target.dataset.date;
        
        if (targetUserId !== draggedAssignment.userId || targetDate !== draggedAssignment.date) {
            moveAssignment(draggedAssignment.assignmentId, targetUserId, targetDate);
        }
    }
}

// Selection Functions
function toggleAssignmentSelection(element) {
    const assignmentId = element.dataset.assignmentId;
    
    if (selectedAssignments.has(assignmentId)) {
        selectedAssignments.delete(assignmentId);
        element.classList.remove('selected');
    } else {
        selectedAssignments.add(assignmentId);
        element.classList.add('selected');
    }
    
    updateBulkActionsVisibility();
}

function clearSelection() {
    selectedAssignments.clear();
    document.querySelectorAll('.assignment-block.selected').forEach(el => {
        el.classList.remove('selected');
    });
    updateBulkActionsVisibility();
}

function updateBulkActionsVisibility() {
    const bulkActions = document.getElementById('bulk-actions');
    const selectionCount = document.getElementById('selection-count');
    
    if (selectedAssignments.size > 0) {
        bulkActions.classList.add('show');
        selectionCount.textContent = selectedAssignments.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

// Bulk Operations
async function bulkMoveAssignments() {
    if (selectedAssignments.size === 0) return;
    
    const modal = `
        <div onclick="this.remove()" class="fixed inset-0 bg-black/50 z-[999]"></div>
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
                    bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl
                    z-[1000] min-w-[400px]">
            <h3 class="mb-4 text-gray-900 dark:text-gray-100 text-lg font-semibold">Bulk Move Assignments</h3>
            <p class="text-gray-700 dark:text-gray-300">Moving ${selectedAssignments.size} assignments. Click on a target cell to move all selected assignments there.</p>
            <div class="mt-5 flex gap-2 justify-end">
                <button onclick="this.closest('div').parentNode.remove();" 
                        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white border-0 rounded-md cursor-pointer transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modal;
    document.body.appendChild(modalContainer);
}

async function bulkCopyAssignments() {
    showNotification(`Copying ${selectedAssignments.size} assignments (feature coming soon)`, 'info');
}

async function bulkDeleteAssignments() {
    if (selectedAssignments.size === 0) return;
    
    if (confirm(`Are you sure you want to delete ${selectedAssignments.size} assignments?`)) {
        showNotification(`Deleting ${selectedAssignments.size} assignments (feature coming soon)`, 'info');
        clearSelection();
    }
}

// Keyboard Shortcuts
function handleKeyboardShortcuts(e) {
    // Ctrl/Cmd + A - Select all visible assignments
    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        selectAllAssignments();
    }
    
    // Delete key - Delete selected assignments
    if (e.key === 'Delete' && selectedAssignments.size > 0) {
        bulkDeleteAssignments();
    }
    
    // Escape - Clear selection
    if (e.key === 'Escape') {
        clearSelection();
    }
}

function selectAllAssignments() {
    clearSelection();
    document.querySelectorAll('.assignment-block').forEach(element => {
        const assignmentId = element.dataset.assignmentId;
        if (assignmentId) {
            selectedAssignments.add(assignmentId);
            element.classList.add('selected');
        }
    });
    updateBulkActionsVisibility();
}

// API Functions
async function moveAssignment(assignmentId, targetUserId, targetDate) {
    try {
        showNotification('Moving assignment...', 'info');
        
        // Here you would make the actual API call
        // For now, just simulate the move
        const response = await fetch(`/api/v1/assignments/${assignmentId}/move/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                user_id: targetUserId,
                date: targetDate
            })
        });
        
        if (response.ok) {
            showNotification('Assignment moved successfully!', 'success');
            // Refresh calendar to show visual changes (consolidation/splitting)
            loadCalendarData();
        } else {
            throw new Error('Failed to move assignment');
        }
        
    } catch (error) {
        console.error('Error moving assignment:', error);
        showNotification('Assignment move simulation - refreshing calendar', 'warning');
        
        // For demo purposes, refresh the calendar after a delay to show visual changes
        setTimeout(() => {
            loadCalendarData();
        }, 1000);
    }
}

function updateCalendarStats() {
    if (!calendarData) return;
    
    let totalAssignments = 0;
    let activeUsers = 0;
    let waakdienstDaysNeeded = 0;
    let waakdienstDaysCovered = 0;
    let incidentDaysNeeded = 0;
    let incidentDaysCovered = 0;
    
    calendarData.users.forEach(user => {
        let userHasAssignments = false;
        calendarData.days.forEach(day => {
            const dayAssignments = user.assignments[day.date] || [];
            if (dayAssignments.length > 0) {
                totalAssignments += dayAssignments.length;
                userHasAssignments = true;
            }
        });
        if (userHasAssignments) {
            activeUsers++;
        }
    });
    
    // Calculate separate coverage for Waakdienst (7 days) and Incident (5 weekdays only)
    calendarData.days.forEach(day => {
        // Waakdienst needed every day (7 days a week)
        waakdienstDaysNeeded++;
        
        // Incident only needed on weekdays (Monday-Friday)
        if (!day.is_weekend) {
            incidentDaysNeeded++;
        }
        
        let hasIncident = false;
        let hasWaakdienst = false;
        
        // Check all users for this day to see if shifts are covered
        calendarData.users.forEach(user => {
            const dayAssignments = user.assignments[day.date] || [];
            dayAssignments.forEach(assignment => {
                const assignmentType = assignment.type.toLowerCase();
                if (assignmentType === 'incident') {
                    hasIncident = true;
                } else if (assignmentType === 'waakdienst') {
                    hasWaakdienst = true;
                }
            });
        });
        
        // Count covered days
        if (hasWaakdienst) waakdienstDaysCovered++;
        if (hasIncident && !day.is_weekend) incidentDaysCovered++; // Only count incident coverage on weekdays
    });
    
    const waakdienstCoverage = waakdienstDaysNeeded > 0 ? Math.round((waakdienstDaysCovered / waakdienstDaysNeeded) * 100) : 0;
    const incidentCoverage = incidentDaysNeeded > 0 ? Math.round((incidentDaysCovered / incidentDaysNeeded) * 100) : 0;
    
    // Update stats display
    document.getElementById('total-assignments').textContent = totalAssignments;
    document.getElementById('active-users').textContent = activeUsers;
    document.getElementById('waakdienst-coverage').textContent = `${waakdienstCoverage}%`;
    document.getElementById('incident-coverage').textContent = `${incidentCoverage}%`;
}

// Context Menu Functions
function showContextMenu(x, y) {
    const contextMenu = document.getElementById('context-menu');
    contextMenu.style.display = 'block';
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    
    // Adjust position if menu goes off screen
    const rect = contextMenu.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
        contextMenu.style.left = (x - rect.width) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
        contextMenu.style.top = (y - rect.height) + 'px';
    }
}

function hideContextMenu() {
    const contextMenu = document.getElementById('context-menu');
    contextMenu.style.display = 'none';
    contextMenuTarget = null;
}

function contextAction(action) {
    hideContextMenu();
    
    if (!contextMenuTarget) return;
    
    const { assignment, user, day, element } = contextMenuTarget;
    
    switch (action) {
        case 'view':
            showAssignmentDetails(assignment, user, day);
            break;
        case 'edit':
            showNotification('Edit assignment feature coming soon', 'info');
            break;
        case 'copy':
            showNotification('Copy assignment feature coming soon', 'info');
            break;
        case 'move':
            showNotification('Drag the assignment to move it, or use bulk move', 'info');
            break;
        case 'delete':
            if (confirm('Are you sure you want to delete this assignment?')) {
                showNotification('Delete assignment feature coming soon', 'warning');
            }
            break;
    }
}
</script>
{% endblock %}
