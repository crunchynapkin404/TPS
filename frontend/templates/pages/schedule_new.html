{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    /* Make calendar take full viewport, accounting for sidebar */
    .calendar-container {
        position: fixed !important;
        top: 0 !important;
        left: 280px !important; /* w-70 = 280px */
        right: 0 !important;
        bottom: 0 !important;
        height: 100vh !important;
        width: calc(100vw - 280px) !important;
        z-index: 10 !important;
    }
    
    /* Large screen sidebar adjustment */
    @media (min-width: 1024px) {
        .calendar-container {
            left: 320px !important; /* lg:w-80 = 320px */
            width: calc(100vw - 320px) !important;
        }
    }
    
    /* Perfect alignment for all calendar views using CSS Grid */
    .calendar-grid {
        display: grid;
        grid-template-rows: auto 1fr;
        height: 100%;
    }

    /* Week view specific CSS Grid */
    .week-container {
        display: grid;
        grid-template-columns: 200px 1fr;
        grid-template-rows: auto 1fr;
        height: 100%;
        gap: 0;
    }

    .week-header-corner {
        grid-column: 1;
        grid-row: 1;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        border-bottom: 1px solid #e2e8f0;
    }

    .week-days-header {
        grid-column: 2;
        grid-row: 1;
        display: flex;
        border-bottom: 1px solid #e2e8f0;
    }

    .week-users-list {
        grid-column: 1;
        grid-row: 2;
        border-right: 1px solid #e2e8f0;
        overflow-y: auto;
    }

    .week-content {
        grid-column: 2;
        grid-row: 2;
        overflow: auto;
    }

    /* Month view specific CSS Grid */
    .month-container {
        display: grid;
        grid-template-columns: 200px 1fr;
        grid-template-rows: auto 1fr;
        height: 100%;
        gap: 0;
    }

    .month-header-corner {
        grid-column: 1;
        grid-row: 1;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        border-bottom: 1px solid #e2e8f0;
    }

    .month-days-header {
        grid-column: 2;
        grid-row: 1;
        display: flex;
        border-bottom: 1px solid #e2e8f0;
    }

    .month-users-list {
        grid-column: 1;
        grid-row: 2;
        border-right: 1px solid #e2e8f0;
        overflow-y: auto;
    }

    .month-content {
        grid-column: 2;
        grid-row: 2;
        overflow: auto;
    }

    /* Year view styling */
    .year-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    /* Assignment blocks with enhanced styling */
    .assignment-block {
        font-size: 10px;
        padding: 3px 6px;
        margin-bottom: 1px;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .assignment-block:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10;
        border-color: rgba(255,255,255,0.4);
    }

    .assignment-block:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* Assignment type specific styles with gradients */
    .assignment-waakdienst {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        border-left: 3px solid #1d4ed8;
    }

    .assignment-incident {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        border-left: 3px solid #b91c1c;
    }

    .assignment-standby {
        background: linear-gradient(135deg, #10b981, #059669);
        border-left: 3px solid #047857;
    }

    .assignment-training {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        border-left: 3px solid #6d28d9;
    }

    .assignment-meeting {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        border-left: 3px solid #b45309;
    }

    .assignment-leave {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        border-left: 3px solid #374151;
    }

    .assignment-changes {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        border-left: 3px solid #4338ca;
    }

    .assignment-maintenance {
        background: linear-gradient(135deg, #14b8a6, #0d9488);
        border-left: 3px solid #0f766e;
    }

    .assignment-other {
        background: linear-gradient(135deg, #64748b, #475569);
        border-left: 3px solid #334155;
    }

    /* Calendar cell enhancements */
    .calendar-cell {
        position: relative;
        transition: all 0.2s ease;
        min-height: 60px;
        border-bottom: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
    }

    .calendar-cell:hover {
        background-color: rgba(59, 130, 246, 0.05);
    }

    .calendar-cell.has-assignments {
        background-color: rgba(248, 250, 252, 0.8);
    }

    /* Weekend and today indicators - subtle background highlights */
    .day-weekend {
        background: linear-gradient(135deg, #fef3c7, #fde68a) !important;
        border-top: 2px solid #f59e0b;
    }

    .day-today {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
        border-top: 3px solid #3b82f6;
        box-shadow: 0 0 0 1px #93c5fd;
        animation: todayPulse 2s infinite;
    }

    @keyframes todayPulse {
        0%, 100% { box-shadow: 0 0 0 1px #93c5fd; }
        50% { box-shadow: 0 0 0 2px #93c5fd; }
    }
    
    /* Cell weekend/today backgrounds - much more subtle */
    .calendar-cell.cell-weekend {
        background-color: rgba(251, 191, 36, 0.05) !important;
        border-right: 1px solid #f59e0b;
        border-left: 3px solid #f59e0b;
    }
    
    .calendar-cell.cell-today {
        background-color: rgba(59, 130, 246, 0.08) !important;
        border-right: 2px solid #3b82f6;
        border-left: 3px solid #3b82f6;
        position: relative;
    }
    
    .calendar-cell.cell-today::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: #3b82f6;
        z-index: 1;
    }

    /* Consolidated assignment special styling */
    .assignment-block[data-is-consolidated="true"] {
        background: linear-gradient(135deg, #3b82f6, #1e40af, #1e3a8a) !important;
        border-left: 4px solid #1d4ed8 !important;
        font-weight: 700;
        position: relative;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        border: 1px solid rgba(255,255,255,0.3);
    }

    .assignment-block[data-is-consolidated="true"]::after {
        content: '';
        position: absolute;
        top: 2px;
        right: 2px;
        width: 8px;
        height: 8px;
        background: #fbbf24;
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.8), 0 1px 3px rgba(0,0,0,0.2);
    }

    .assignment-block[data-is-consolidated="true"]::before {
        content: attr(data-shift-count) 'x';
        position: absolute;
        top: 1px;
        left: 2px;
        font-size: 8px;
        font-weight: 800;
        color: rgba(255,255,255,0.9);
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Drag and drop visual feedback */
    .assignment-block.dragging {
        opacity: 0.7;
        transform: rotate(2deg) scale(1.05);
        z-index: 1000;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        cursor: grabbing;
    }

    .calendar-cell.drag-over {
        background-color: rgba(59, 130, 246, 0.15);
        border: 2px dashed #3b82f6;
        border-radius: 6px;
        transform: scale(1.02);
        transition: all 0.2s ease;
    }

    .calendar-cell.empty-cell::before {
        content: '+';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 24px;
        border: 2px dashed #d1d5db;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #9ca3af;
        font-weight: bold;
    }

    .calendar-cell.empty-cell:hover::before {
        opacity: 1;
        border-color: #3b82f6;
        color: #3b82f6;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .assignment-block {
            font-size: 9px;
            padding: 1px 4px;
        }
        
        .calendar-cell {
            min-height: 50px;
        }
        
        .week-container,
        .month-container {
            grid-template-columns: 150px 1fr;
        }
    }

    /* Dark mode adjustments */
    .dark .calendar-cell {
        border-bottom: 1px solid #374151;
        border-right: 1px solid #374151;
    }
    
    .dark .calendar-cell.has-assignments {
        background-color: rgba(31, 41, 55, 0.8);
    }
    
    .dark .calendar-cell.empty-cell::before {
        border-color: #4b5563;
    }
    
    .dark .assignment-block {
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .dark .calendar-cell.cell-weekend {
        background-color: rgba(217, 119, 6, 0.1) !important;
        border-left: 3px solid #f59e0b;
    }
    
    .dark .calendar-cell.cell-today {
        background-color: rgba(37, 99, 235, 0.15) !important;
        border-left: 3px solid #3b82f6;
    }

    /* Scrollbar styling */
    .month-content::-webkit-scrollbar,
    .week-content::-webkit-scrollbar,
    .month-users-list::-webkit-scrollbar,
    .week-users-list::-webkit-scrollbar {
        width: 6px;
    }

    .month-content::-webkit-scrollbar-track,
    .week-content::-webkit-scrollbar-track,
    .month-users-list::-webkit-scrollbar-track,
    .week-users-list::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    .month-content::-webkit-scrollbar-thumb,
    .week-content::-webkit-scrollbar-thumb,
    .month-users-list::-webkit-scrollbar-thumb,
    .week-users-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .month-content::-webkit-scrollbar-thumb:hover,
    .week-content::-webkit-scrollbar-thumb:hover,
    .month-users-list::-webkit-scrollbar-thumb:hover,
    .week-users-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="calendar-container h-full flex flex-col bg-white dark:bg-gray-800 overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 dark:from-blue-800 dark:to-blue-900 text-white p-3 flex-shrink-0">
        <div class="flex justify-between items-center">
            <!-- Title & Stats -->
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-bold">Team Schedule</h1>
                <div class="flex gap-4 text-sm">
                    <div class="text-center">
                        <div class="font-semibold" id="total-assignments">-</div>
                        <div class="opacity-80">Assignments</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold" id="active-users">-</div>
                        <div class="opacity-80">Active Users</div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation & View Switcher -->
            <div class="flex items-center gap-4">
                <!-- View Switcher -->
                <div class="flex bg-white/10 rounded-lg p-1">
                    <button onclick="switchView('week')" id="view-week" class="px-3 py-1 rounded-md text-xs font-medium transition-colors">
                        Week
                    </button>
                    <button onclick="switchView('month')" id="view-month" class="px-3 py-1 rounded-md text-xs font-medium bg-white/20 text-white">
                        Month
                    </button>
                    <button onclick="switchView('year')" id="view-year" class="px-3 py-1 rounded-md text-xs font-medium transition-colors">
                        Year
                    </button>
                </div>
                
                <!-- Navigation -->
                <div class="flex items-center gap-2">
                    <button onclick="navigatePrevious()" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors text-sm">
                        ← Previous
                    </button>
                    <div class="px-3 py-2 font-semibold text-sm" id="current-period">Loading...</div>
                    <button onclick="navigateNext()" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors text-sm">
                        Next →
                    </button>
                    <button onclick="goToToday()" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors text-sm">
                        Today
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Views Container -->
    <div class="flex-1 flex flex-col min-h-0">
        <!-- Week View -->
            <!-- Week View -->
    <div id="week-view" class="hidden">
        <div class="week-container">
            <!-- Header corner -->
            <div class="week-header-corner p-3 flex items-center justify-center">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Team Members</span>
            </div>
            
            <!-- Days header -->
            <div id="week-days-header" class="week-days-header">
                <!-- Days will be populated by JavaScript -->
            </div>
            
            <!-- Users list -->
            <div id="week-users-list" class="week-users-list">
                <!-- Users will be populated by JavaScript -->
            </div>
            
            <!-- Assignment content -->
            <div id="week-content" class="week-content">
                <!-- Assignment grid will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Month View -->
    <div id="month-view" class="flex-1 flex flex-col min-h-0">
        <div class="month-container">
            <!-- Header corner -->
            <div class="month-header-corner p-3 flex items-center justify-center">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Team Members</span>
            </div>
            
            <!-- Days header -->
            <div id="days-header" class="month-days-header">
                <!-- Days will be populated by JavaScript -->
            </div>
            
            <!-- Users list -->
            <div id="users-list" class="month-users-list">
                <!-- Users will be populated by JavaScript -->
            </div>
            
            <!-- Assignment content -->
            <div id="assignments-grid" class="month-content">
                <!-- Assignment grid will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Year View -->
    <div id="year-view" class="hidden flex-1 p-4 overflow-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-w-7xl mx-auto" id="year-months">
            <!-- 12 month cards will be generated here -->
        </div>
    </div>
    </div>
</div>

<!-- Notification Area -->
<div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Assignment Modal -->
<div id="assignment-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
        <!-- Modal content will be inserted here -->
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
console.log('🚀 New Calendar Loading...');

// Global state
let currentDate = new Date();
let currentTeamId = 4; // Use working team ID like the old version
let calendarData = null;
let isLoading = false;
let currentView = 'month'; // week, month, year

// Utility functions
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.content || '';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
    };
    
    notification.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300`;
    notification.textContent = message;
    
    const container = document.getElementById('notifications');
    container.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function formatDate(date) {
    return new Date(date).toLocaleDateString('en-GB');
}

function formatTime(time) {
    return time.substring(0, 5); // Remove seconds
}

// Calendar loading function
async function loadCalendar() {
    if (isLoading) {
        console.log('⏳ Already loading, skipping...');
        return;
    }
    
    isLoading = true;
    console.log(`📅 Loading ${currentView} view data for team ID:`, currentTeamId);
    
    // Update period display
    updatePeriodDisplay();
    
    try {
        if (currentView === 'year') {
            await loadYearView();
        } else {
            await loadTimelineView(); // For week and month views
        }
        
        showNotification('Calendar loaded successfully!', 'success');
        
    } catch (error) {
        console.error('❌ Error loading calendar:', error);
        showNotification(`Error: ${error.message}`, 'error');
        renderFallback(error);
    } finally {
        isLoading = false;
    }
}

function updatePeriodDisplay() {
    const periodElement = document.getElementById('current-period');
    if (!periodElement) return;
    
    if (currentView === 'week') {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1); // Monday
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6); // Sunday
        
        periodElement.textContent = `${startOfWeek.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${endOfWeek.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
    } else if (currentView === 'month') {
        periodElement.textContent = currentDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    } else if (currentView === 'year') {
        periodElement.textContent = currentDate.getFullYear().toString();
    }
}

async function loadTimelineView() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    
    console.log('📅 loadTimelineView called with:', { view: currentView, year, month, today: todayString });
    showNotification('Loading calendar...', 'info');
    
    let url;
    if (currentView === 'week') {
        // For week view, get current week's data starting from today if current week
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1); // Monday
        
        // If viewing current week, start from today
        let startDate;
        if (startOfWeek <= today && today <= new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000)) {
            startDate = todayString;
        } else {
            startDate = startOfWeek.toISOString().split('T')[0];
        }
        
        url = `/api/v1/calendar/${currentTeamId}/month/?year=${startOfWeek.getFullYear()}&month=${startOfWeek.getMonth() + 1}&start_date=${startDate}&days=7&extend_to_next_month=true`;
    } else {
        // Month view - start from today if viewing current month
        let startDate;
        if (year === today.getFullYear() && month === today.getMonth() + 1) {
            startDate = todayString;
        } else {
            startDate = `${year}-${month.toString().padStart(2, '0')}-01`;
        }
        
        url = `/api/v1/calendar/${currentTeamId}/month/?year=${year}&month=${month}&start_date=${startDate}&extend_to_next_month=true`;
    }
    
    console.log('🔗 Fetching from:', url);
    console.log('🔑 CSRF Token:', getCSRFToken());
    
    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        console.log('📡 Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ API Error:', errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
        }
        
        calendarData = await response.json();
        console.log('✅ Calendar data loaded:', calendarData);
        console.log('👥 Users count:', calendarData.users?.length || 0);
        console.log('📅 Days count:', calendarData.days?.length || 0);
        
        // Filter days to start from today if we're viewing current month/week
        if (calendarData.days && year === today.getFullYear() && month === today.getMonth() + 1) {
            const originalDaysCount = calendarData.days.length;
            calendarData.days = calendarData.days.filter(day => day.date >= todayString);
            console.log(`📅 Filtered days from ${originalDaysCount} to ${calendarData.days.length} (starting from today)`);
        }
        
        if (currentView === 'week') {
            renderWeekView();
        } else {
            renderMonthView();
        }
        
    } catch (error) {
        console.error('❌ Fetch error:', error);
        throw error;
    }
}

async function loadYearView() {
    showNotification('Loading year view...', 'info');
    
    // For year view, we'll load summary data for each month
    const year = currentDate.getFullYear();
    
    // Simple approach: just render the year structure
    // In a real app, you might want to load summary data for each month
    renderYearView(year);
}

// Calendar rendering functions
function renderWeekView() {
    console.log('🎨 Rendering week view');
    
    if (!calendarData || !calendarData.users) {
        renderFallback();
        return;
    }
    
    // Clear all week containers
    const weekDaysHeader = document.getElementById('week-days-header');
    const weekUsersList = document.getElementById('week-users-list');
    const weekContent = document.getElementById('week-content');
    
    weekDaysHeader.innerHTML = '';
    weekUsersList.innerHTML = '';
    weekContent.innerHTML = '';
    
    const today = new Date().toISOString().split('T')[0];
    
    // Take first 7 days for week view
    const weekDays = calendarData.days.slice(0, 7);
    
    // Render week days header
    weekDays.forEach((day, index) => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'flex-1 p-2 text-center min-w-0 border-r border-gray-200 dark:border-gray-600';
        
        if (day.is_weekend) dayDiv.className += ' bg-gray-100 dark:bg-gray-700';
        if (day.date === today) dayDiv.className += ' bg-blue-100 dark:bg-blue-900 font-bold';
        
        dayDiv.innerHTML = `
            <div class="text-xs text-gray-600 dark:text-gray-400 truncate">${day.day_name}</div>
            <div class="text-sm font-semibold">${day.day_number}</div>
        `;
        weekDaysHeader.appendChild(dayDiv);
    });
    
    // Calculate height per user
    const userHeight = `calc(100% / ${calendarData.users.length})`;
    
    // Render users column
    calendarData.users.forEach((user, userIndex) => {
        const userDiv = document.createElement('div');
        userDiv.className = 'flex items-center p-2 border-b border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800';
        userDiv.style.height = '60px';
        userDiv.innerHTML = `
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-semibold text-xs mr-2 flex-shrink-0">
                ${user.initials}
            </div>
            <div class="font-medium text-gray-900 dark:text-gray-100 text-sm truncate">${user.name}</div>
        `;
        weekUsersList.appendChild(userDiv);
    });
    
    // Render assignment grid
    const assignmentContainer = document.createElement('div');
    assignmentContainer.className = 'flex flex-col h-full';
    
    calendarData.users.forEach((user, userIndex) => {
        const userRow = document.createElement('div');
        userRow.className = 'calendar-row flex border-b border-gray-200 dark:border-gray-600';
        
        weekDays.forEach((day, dayIndex) => {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell flex-1 hover:bg-gray-50 dark:hover:bg-gray-700 flex flex-col min-w-0 overflow-hidden border-r border-b border-gray-200 dark:border-gray-600';
            cell.dataset.userId = user.id;
            cell.dataset.date = day.date;
            cell.dataset.userName = user.name;
            
            // Add assignments for this user on this day
            const userAssignments = user.assignments[day.date] || [];
            
            if (userAssignments.length > 0) {
                // Show up to 3 assignments for week view (smaller space)
                const maxVisible = 3;
                const visibleAssignments = userAssignments.slice(0, maxVisible);
                
                visibleAssignments.forEach(assignment => {
                    const assignmentBlock = document.createElement('div');
                    const type = assignment.type.toLowerCase();
                    
                    assignmentBlock.className = `assignment-block assignment-${type}`;
                    assignmentBlock.textContent = assignment.type;
                    assignmentBlock.title = `${assignment.type}: ${formatTime(assignment.start_time)}-${formatTime(assignment.end_time)}`;
                    
                    assignmentBlock.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showAssignmentDetails(assignment, user, day);
                    });
                    
                    cell.appendChild(assignmentBlock);
                });
                
                if (userAssignments.length > maxVisible) {
                    const countBadge = document.createElement('div');
                    countBadge.className = 'assignment-count';
                    countBadge.textContent = `+${userAssignments.length - maxVisible}`;
                    cell.appendChild(countBadge);
                }
            } else {
                cell.addEventListener('click', () => showQuickAdd(user, day));
                cell.className += ' cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20';
                cell.title = `Add assignment for ${user.name} on ${formatDate(day.date)}`;
                
                const addIcon = document.createElement('div');
                addIcon.className = 'flex-1 flex items-center justify-center text-gray-300 dark:text-gray-600';
                addIcon.innerHTML = '+';
                cell.appendChild(addIcon);
            }
            
            userRow.appendChild(cell);
        });
        
        assignmentContainer.appendChild(userRow);
    });
    
    weekContent.appendChild(assignmentContainer);
    updateStats();
}

function renderMonthView() {
    console.log('🎨 Rendering month view');
    renderCalendar(); // Use existing month view logic
}

function renderYearView(year) {
    console.log('🎨 Rendering year view for', year);
    
    const yearMonths = document.getElementById('year-months');
    yearMonths.innerHTML = '';
    
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    months.forEach((monthName, index) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 p-4 hover:shadow-md transition-shadow cursor-pointer';
        
        const monthDate = new Date(year, index, 1);
        const isCurrentMonth = new Date().getMonth() === index && new Date().getFullYear() === year;
        
        if (isCurrentMonth) {
            monthCard.className += ' ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20';
        }
        
        monthCard.innerHTML = `
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-gray-900 dark:text-gray-100">${monthName}</h3>
                <span class="text-sm text-gray-500 dark:text-gray-400">${year}</span>
            </div>
            
            <!-- Mini Calendar Grid -->
            <div class="grid grid-cols-7 gap-1 text-xs">
                <div class="text-center font-medium text-gray-600 dark:text-gray-400 py-1">M</div>
                <div class="text-center font-medium text-gray-600 dark:text-gray-400 py-1">T</div>
                <div class="text-center font-medium text-gray-600 dark:text-gray-400 py-1">W</div>
                <div class="text-center font-medium text-gray-600 dark:text-gray-400 py-1">T</div>
                <div class="text-center font-medium text-gray-600 dark:text-gray-400 py-1">F</div>
                <div class="text-center font-medium text-gray-600 dark:text-gray-400 py-1">S</div>
                <div class="text-center font-medium text-gray-600 dark:text-gray-400 py-1">S</div>
                ${generateMiniCalendarDays(year, index)}
            </div>
            
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    Click to view month
                </div>
            </div>
        `;
        
        monthCard.addEventListener('click', () => {
            currentDate = monthDate;
            switchView('month');
        });
        
        yearMonths.appendChild(monthCard);
    });
}

function generateMiniCalendarDays(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    
    // Adjust to Monday (1) instead of Sunday (0)
    const dayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
    startDate.setDate(firstDay.getDate() - dayOfWeek);
    
    let daysHTML = '';
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    for (let i = 0; i < 42; i++) { // 6 weeks
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const isCurrentMonth = currentDate.getMonth() === month;
        const isToday = currentDate.toISOString().split('T')[0] === todayStr;
        
        let className = 'text-center py-1 rounded';
        if (!isCurrentMonth) className += ' text-gray-400 dark:text-gray-600';
        if (isToday) className += ' bg-blue-500 text-white';
        else if (isCurrentMonth) className += ' hover:bg-gray-100 dark:hover:bg-gray-700';
        
        daysHTML += `<div class="${className}">${currentDate.getDate()}</div>`;
        
        if ((i + 1) % 7 === 0 && i > 20 && currentDate.getMonth() !== month) break;
    }
    
    return daysHTML;
}

// Calendar rendering function (for month view)
function renderCalendar() {
    console.log('🎨 renderCalendar() called');
    
    if (!calendarData) {
        console.error('❌ No calendarData available');
        renderFallback(new Error('No calendar data available'));
        return;
    }
    
    if (!calendarData.users || !calendarData.days) {
        console.error('❌ Invalid calendar data structure:', calendarData);
        renderFallback(new Error('Invalid calendar data structure'));
        return;
    }
    
    console.log('🎨 Rendering calendar with data:', {
        users: calendarData.users?.length || 0,
        days: calendarData.days?.length || 0,
        month: calendarData.month_name,
        year: calendarData.year
    });
    
    try {
        updateStats();
        
        // Render users
        console.log('👥 Rendering users...');
        renderUsers();
        
        // Render days header
        console.log('📅 Rendering days header...');
        renderDaysHeader();
        
        // Render assignments grid
        console.log('📋 Rendering assignments grid...');
        renderAssignmentsGrid();
        
        console.log('✅ Calendar rendered successfully');
        
    } catch (error) {
        console.error('❌ Error rendering calendar:', error);
        renderFallback(error);
    }
}

function updateStats() {
    if (!calendarData || !calendarData.users) return;
    
    const totalAssignments = calendarData.users.reduce((total, user) => 
        total + Object.values(user.assignments).flat().length, 0
    );
    
    const totalElement = document.getElementById('total-assignments');
    const activeElement = document.getElementById('active-users');
    
    if (totalElement) totalElement.textContent = totalAssignments;
    if (activeElement) activeElement.textContent = calendarData.users.length;
}

function renderUsers() {
    console.log('🎨 renderUsers called');
    const usersList = document.getElementById('users-list');
    console.log('📋 Users list element:', usersList);
    
    usersList.innerHTML = '';
    
    if (!calendarData.users || calendarData.users.length === 0) {
        console.log('⚠️ No users data available');
        usersList.innerHTML = '<div class="flex-1 flex items-center justify-center text-gray-500 dark:text-gray-400 text-sm">No users found</div>';
        return;
    }
    
    console.log('👥 Rendering', calendarData.users.length, 'users');
    
    // Calculate height per user to fill available space
    const userHeight = `calc(100% / ${calendarData.users.length})`;
    
    calendarData.users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'flex items-center p-2 border-b border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 min-h-0';
        userDiv.style.height = '60px';
        userDiv.innerHTML = `
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-semibold text-xs mr-2 flex-shrink-0">
                ${user.initials}
            </div>
            <div class="font-medium text-gray-900 dark:text-gray-100 text-sm truncate">${user.name}</div>
        `;
        usersList.appendChild(userDiv);
    });
    
    console.log('✅ Users rendered successfully');
}

function renderDaysHeader() {
    console.log('📅 renderDaysHeader called');
    const daysHeader = document.getElementById('days-header');
    console.log('📋 Days header element:', daysHeader);
    
    daysHeader.innerHTML = '';
    
    if (!calendarData.days || calendarData.days.length === 0) {
        console.log('⚠️ No days data available');
        return;
    }
    
    console.log('📅 Rendering', calendarData.days.length, 'days');
    
    const today = new Date().toISOString().split('T')[0];
    
    calendarData.days.forEach((day, index) => {
        const dayDiv = document.createElement('div');
        
        // Base classes
        let classes = 'flex-1 p-2 text-center min-w-0 border-r border-gray-200 dark:border-gray-600';
        
        // Weekend styling
        if (day.is_weekend) {
            classes += ' day-weekend';
        } else {
            classes += ' bg-gray-50 dark:bg-gray-800';
        }
        
        // Today styling (overrides weekend if today is weekend)
        if (day.date === today) {
            classes += ' day-today !text-blue-800 dark:!text-blue-200 font-bold';
        }
        
        // Next month styling
        if (day.is_next_month) {
            classes += ' opacity-60';
        }
        
        dayDiv.className = classes;
        
        // Add special indicators
        let dayContent = `
            <div class="text-xs font-medium mb-1 ${day.date === today ? 'text-blue-800 dark:text-blue-200' : (day.is_weekend ? 'text-amber-700 dark:text-amber-300' : 'text-gray-600 dark:text-gray-400')}">${day.day_name}</div>
            <div class="text-sm font-bold ${day.date === today ? 'text-lg text-blue-900 dark:text-blue-100' : ''}">${day.day_number}</div>
        `;
        
        // Add today indicator
        if (day.date === today) {
            dayContent += '<div class="text-xs mt-1 text-blue-700 dark:text-blue-300 font-medium">TODAY</div>';
        }
        
        // Add weekend indicator
        if (day.is_weekend && day.date !== today) {
            dayContent += '<div class="text-xs mt-1 text-amber-600 dark:text-amber-300">Weekend</div>';
        }
        
        dayDiv.innerHTML = dayContent;
        daysHeader.appendChild(dayDiv);
    });
    
    console.log('✅ Days header rendered successfully');
}

function renderAssignmentsGrid() {
    const assignmentsGrid = document.getElementById('assignments-grid');
    assignmentsGrid.innerHTML = '';
    
    if (!calendarData.users || calendarData.users.length === 0) {
        assignmentsGrid.innerHTML = '<div class="flex-1 flex items-center justify-center text-gray-500 dark:text-gray-400 text-sm">No assignments to display</div>';
        return;
    }
    
    // Calculate height per user to match the users column exactly
    const userHeight = `calc(100% / ${calendarData.users.length})`;
    
    // Create a row for each user
    calendarData.users.forEach((user, userIndex) => {
        const userRow = document.createElement('div');
        userRow.className = 'calendar-row flex min-h-0';
        
        // Create a cell for each day for this user
        calendarData.days.forEach((day, dayIndex) => {
            const cell = document.createElement('div');
            const today = new Date().toISOString().split('T')[0];
            
            // Base cell styling
            let cellClasses = 'calendar-cell flex-1 flex flex-col min-w-0 overflow-hidden p-1 border-r border-b border-gray-200 dark:border-gray-600 min-h-[60px]';
            
            // Weekend styling
            if (day.is_weekend) {
                cellClasses += ' cell-weekend';
            } else {
                cellClasses += ' hover:bg-gray-50 dark:hover:bg-gray-700';
            }
            
            // Today styling
            if (day.date === today) {
                cellClasses += ' cell-today';
            }
            
            cell.className = cellClasses;
            cell.dataset.userId = user.id;
            cell.dataset.date = day.date;
            cell.dataset.userName = user.name;
            
            // Get assignments for this user on this day
            const userAssignments = user.assignments[day.date] || [];
            
            // Waakdienst consolidation logic
            let processedAssignments = [];
            const waakdienstShifts = userAssignments.filter(a => a.type.toLowerCase() === 'waakdienst');
            const otherShifts = userAssignments.filter(a => a.type.toLowerCase() !== 'waakdienst');
            
            // Handle Waakdienst consolidation - consolidate multiple Waakdienst shifts into one block
            if (waakdienstShifts.length > 1) {
                // Sort by start time
                waakdienstShifts.sort((a, b) => a.start_time.localeCompare(b.start_time));
                
                const consolidatedShift = {
                    id: `consolidated-waakdienst-${waakdienstShifts.map(s => s.id).join('-')}`,
                    type: 'Waakdienst',
                    start_time: waakdienstShifts[0].start_time,
                    end_time: waakdienstShifts[waakdienstShifts.length - 1].end_time,
                    isConsolidated: true,
                    shiftCount: waakdienstShifts.length,
                    individualShifts: waakdienstShifts,
                    user_id: user.id,
                    date: day.date
                };
                processedAssignments.push(consolidatedShift);
            } else if (waakdienstShifts.length === 1) {
                processedAssignments.push(waakdienstShifts[0]);
            }
            
            // Add other assignments
            processedAssignments = processedAssignments.concat(otherShifts);
            
            if (processedAssignments.length > 0) {
                cell.classList.add('has-assignments');
                
                // Show assignments (max 3 visible)
                const maxVisible = 3;
                const visibleAssignments = processedAssignments.slice(0, maxVisible);
                
                visibleAssignments.forEach(assignment => {
                    const assignmentBlock = document.createElement('div');
                    const type = assignment.type.toLowerCase();
                    
                    // Assignment type colors with gradients
                    const typeColors = {
                        'waakdienst': 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800',
                        'incident': 'bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800',
                        'standby': 'bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800',
                        'training': 'bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800',
                        'meeting': 'bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800',
                        'leave': 'bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800',
                        'changes': 'bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800',
                        'maintenance': 'bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800',
                        'other': 'bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800'
                    };
                    
                    const colorClass = typeColors[type] || typeColors['other'];
                    assignmentBlock.className = `assignment-block text-xs px-2 py-1 mb-1 rounded text-white cursor-pointer truncate font-medium shadow-sm hover:shadow-md transition-all duration-200 ${colorClass}`;
                    
                    // Set content and tooltip
                    if (assignment.isConsolidated) {
                        assignmentBlock.innerHTML = `🛡️ Waakdienst (${assignment.shiftCount})`;
                        assignmentBlock.title = `🛡️ Waakdienst - ${assignment.shiftCount} shifts consolidated\n${assignment.start_time} - ${assignment.end_time}\nClick for details`;
                        assignmentBlock.dataset.isConsolidated = 'true';
                        assignmentBlock.dataset.individualShifts = JSON.stringify(assignment.individualShifts);
                    } else {
                        assignmentBlock.textContent = assignment.type;
                        assignmentBlock.title = `${assignment.type}\n${formatTime(assignment.start_time)} - ${formatTime(assignment.end_time)}`;
                    }
                    
                    assignmentBlock.dataset.assignmentId = assignment.id;
                    assignmentBlock.dataset.userId = user.id;
                    assignmentBlock.dataset.date = day.date;
                    
                    // Add click handler
                    assignmentBlock.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (assignment.isConsolidated) {
                            showConsolidatedAssignmentDetails(assignment, user, day);
                        } else {
                            showAssignmentDetails(assignment, user, day);
                        }
                    });
                    
                    // Add drag and drop (basic)
                    assignmentBlock.draggable = true;
                    assignmentBlock.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', JSON.stringify({
                            assignmentId: assignment.id,
                            userId: user.id,
                            date: day.date,
                            isConsolidated: assignment.isConsolidated || false
                        }));
                        assignmentBlock.classList.add('opacity-50');
                    });
                    
                    assignmentBlock.addEventListener('dragend', () => {
                        assignmentBlock.classList.remove('opacity-50');
                    });
                    
                    cell.appendChild(assignmentBlock);
                });
                
                // Show overflow indicator if there are more assignments
                if (processedAssignments.length > maxVisible) {
                    const overflowCount = processedAssignments.length - maxVisible;
                    const overflowDiv = document.createElement('div');
                    overflowDiv.className = 'text-xs text-gray-500 dark:text-gray-400 px-1 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-center cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700';
                    overflowDiv.textContent = `+${overflowCount} more`;
                    overflowDiv.title = 'Click to view all assignments';
                    overflowDiv.addEventListener('click', () => {
                        showAllAssignments(user, day, processedAssignments);
                    });
                    cell.appendChild(overflowDiv);
                }
                
            } else {
                // Empty cell - add quick add functionality
                cell.classList.add('empty-cell', 'cursor-pointer');
                cell.title = `Add assignment for ${user.name} on ${formatDate(day.date)}`;
                
                const addOverlay = document.createElement('div');
                addOverlay.className = 'flex-1 flex items-center justify-center text-gray-300 dark:text-gray-600 hover:text-blue-500 dark:hover:text-blue-400 transition-colors text-lg font-bold opacity-0 hover:opacity-100';
                addOverlay.innerHTML = '+';
                cell.appendChild(addOverlay);
                
                cell.addEventListener('click', () => showQuickAdd(user, day));
                cell.addEventListener('mouseenter', () => {
                    if (!day.is_weekend) {
                        cell.classList.add('hover:bg-blue-50', 'dark:hover:bg-blue-900/20');
                    }
                });
            }
            
            // Add drop zone functionality for drag & drop
            cell.addEventListener('dragover', (e) => {
                e.preventDefault();
                cell.classList.add('bg-blue-100', 'dark:bg-blue-900/40', 'ring-2', 'ring-blue-300');
            });
            
            cell.addEventListener('dragleave', () => {
                cell.classList.remove('bg-blue-100', 'dark:bg-blue-900/40', 'ring-2', 'ring-blue-300');
            });
            
            cell.addEventListener('drop', (e) => {
                e.preventDefault();
                cell.classList.remove('bg-blue-100', 'dark:bg-blue-900/40', 'ring-2', 'ring-blue-300');
                
                try {
                    const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (dragData.assignmentId && dragData.userId && dragData.date) {
                        handleAssignmentMove(dragData, user.id, day.date);
                    }
                } catch (error) {
                    console.error('Error handling drop:', error);
                    showNotification('Error moving assignment', 'error');
                }
            });
            
            userRow.appendChild(cell);
        });
        
        assignmentsGrid.appendChild(userRow);
    });
}

function renderFallback(error = null) {
    console.log('🚨 renderFallback called', error);
    
    const periodElement = document.getElementById('current-period');
    const usersElement = document.getElementById('users-list');
    const daysElement = document.getElementById('days-header');
    const gridElement = document.getElementById('assignments-grid');
    
    if (periodElement) periodElement.textContent = 'Schedule (Error)';
    
    const errorMessage = error ? error.message : 'Failed to load calendar data';
    
    if (usersElement) {
        usersElement.innerHTML = `<div class="p-4 text-red-500 text-center">
            <div class="font-semibold">Failed to load users</div>
            <div class="text-sm mt-1">${errorMessage}</div>
            <button onclick="loadCalendar()" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-xs">Retry</button>
        </div>`;
    }
    
    if (daysElement) {
        daysElement.innerHTML = `<div class="flex-1 p-4 text-red-500 text-center">
            <div class="font-semibold">Failed to load days</div>
            <div class="text-sm">${errorMessage}</div>
        </div>`;
    }
    
    if (gridElement) {
        gridElement.innerHTML = `<div class="flex-1 flex items-center justify-center text-red-500">
            <div class="text-center">
                <div class="font-semibold">Failed to load assignments</div>
                <div class="text-sm mt-1">${errorMessage}</div>
                <button onclick="loadCalendar()" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-xs">Retry</button>
            </div>
        </div>`;
    }
}

// Modal functions
function showAssignmentDetails(assignment, user, day) {
    const modal = document.getElementById('assignment-modal');
    const content = modal.querySelector('div > div') || modal.querySelector('div');
    
    content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Assignment Details</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="space-y-3">
            <div><strong>User:</strong> ${user.name}</div>
            <div><strong>Date:</strong> ${formatDate(day.date)}</div>
            <div><strong>Type:</strong> ${assignment.type}</div>
            <div><strong>Time:</strong> ${formatTime(assignment.start_time)} - ${formatTime(assignment.end_time)}</div>
            <div><strong>Status:</strong> <span class="capitalize">${assignment.status}</span></div>
        </div>
        
        <div class="flex justify-end gap-2 mt-6">
            <button onclick="closeModal()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                Close
            </button>
            <button onclick="editAssignment(${assignment.id})" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                Edit
            </button>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function showQuickAdd(user, day) {
    const modal = document.getElementById('assignment-modal');
    const content = modal.querySelector('div > div') || modal.querySelector('div');
    
    content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Quick Add Assignment</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form onsubmit="createAssignment(event)" class="space-y-4">
            <div><strong>User:</strong> ${user.name}</div>
            <div><strong>Date:</strong> ${formatDate(day.date)}</div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Type:</label>
                <select name="type" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                    <option value="WAAKDIENST">Waakdienst</option>
                    <option value="INCIDENT">Incident</option>
                    <option value="STANDBY">Standby</option>
                    <option value="TRAINING">Training</option>
                    <option value="MEETING">Meeting</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Start Time:</label>
                    <input type="time" name="start_time" value="08:00" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">End Time:</label>
                    <input type="time" name="end_time" value="17:00" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                </div>
            </div>
            
            <input type="hidden" name="user_id" value="${user.id}">
            <input type="hidden" name="date" value="${day.date}">
            
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    Create Assignment
                </button>
            </div>
        </form>
    `;
    
    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('assignment-modal').classList.add('hidden');
}

// Assignment operations
async function createAssignment(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        showNotification('Creating assignment...', 'info');
        
        const response = await fetch('/api/v1/assignments/create/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            showNotification('Assignment created successfully!', 'success');
            closeModal();
            loadCalendar(); // Refresh calendar
        } else {
            throw new Error('Failed to create assignment');
        }
    } catch (error) {
        console.error('Error creating assignment:', error);
        showNotification('Failed to create assignment', 'error');
    }
}

function editAssignment(assignmentId) {
    showNotification('Edit functionality coming soon!', 'info');
    closeModal();
}

// View management functions
function switchView(view) {
    console.log(`🔄 Switching to ${view} view`);
    currentView = view;
    
    // Update view switcher buttons
    ['week', 'month', 'year'].forEach(v => {
        const btn = document.getElementById(`view-${v}`);
        if (v === view) {
            btn.className = 'px-3 py-1 rounded-md text-xs font-medium bg-white/20 text-white';
        } else {
            btn.className = 'px-3 py-1 rounded-md text-xs font-medium text-white/70 hover:text-white transition-colors';
        }
    });
    
    // Show/hide view containers
    document.getElementById('week-view').className = view === 'week' ? 'flex-1 flex flex-col min-h-0' : 'hidden';
    document.getElementById('month-view').className = view === 'month' ? 'flex-1 flex flex-col min-h-0' : 'hidden';
    document.getElementById('year-view').className = view === 'year' ? 'flex-1 p-4 overflow-auto' : 'hidden';
    
    // Load appropriate data
    loadCalendar();
}

// Navigation functions
function navigatePrevious() {
    if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() - 7);
    } else if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
    } else if (currentView === 'year') {
        currentDate.setFullYear(currentDate.getFullYear() - 1);
    }
    loadCalendar();
}

function navigateNext() {
    if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + 7);
    } else if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
    } else if (currentView === 'year') {
        currentDate.setFullYear(currentDate.getFullYear() + 1);
    }
    loadCalendar();
}

function goToToday() {
    currentDate = new Date();
    loadCalendar();
}

// Modal and interaction functions
function showAssignmentDetails(assignment, user, day) {
    const modal = document.getElementById('assignment-modal');
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Assignment Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-3">
                <div><strong>User:</strong> ${user.name}</div>
                <div><strong>Date:</strong> ${formatDate(day.date)}</div>
                <div><strong>Type:</strong> ${assignment.type}</div>
                <div><strong>Time:</strong> ${formatTime(assignment.start_time)} - ${formatTime(assignment.end_time)}</div>
                <div><strong>Status:</strong> ${assignment.status || 'Active'}</div>
                ${assignment.notes ? `<div><strong>Notes:</strong> ${assignment.notes}</div>` : ''}
            </div>
            
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="deleteAssignment(${assignment.id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    Delete
                </button>
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    `;
    modal.classList.remove('hidden');
}

function showConsolidatedAssignmentDetails(consolidatedAssignment, user, day) {
    const shiftsHTML = consolidatedAssignment.individualShifts.map(shift => `
        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-md mb-2">
            <div class="font-medium">Shift ${shift.id}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">${formatTime(shift.start_time)} - ${formatTime(shift.end_time)}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Status: ${shift.status || 'Active'}</div>
            ${shift.notes ? `<div class="text-sm text-gray-600 dark:text-gray-400">Notes: ${shift.notes}</div>` : ''}
        </div>
    `).join('');
    
    const modal = document.getElementById('assignment-modal');
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                    🛡️ Consolidated Waakdienst
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-3 mb-6">
                <div><strong>User:</strong> ${user.name}</div>
                <div><strong>Date:</strong> ${formatDate(day.date)}</div>
                <div><strong>Total Coverage:</strong> ${formatTime(consolidatedAssignment.start_time)} - ${formatTime(consolidatedAssignment.end_time)}</div>
                <div><strong>Number of Shifts:</strong> ${consolidatedAssignment.shiftCount}</div>
            </div>
            
            <div class="mb-6">
                <h4 class="font-semibold mb-3">Individual Shifts:</h4>
                ${shiftsHTML}
            </div>
            
            <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-md p-3 mb-6">
                <div class="flex items-start gap-2">
                    <div class="text-amber-600 dark:text-amber-400">ℹ️</div>
                    <div class="text-sm text-amber-800 dark:text-amber-200">
                        <strong>Consolidated View:</strong> Multiple Waakdienst shifts for the same user on the same day are shown as one block for clarity. Individual shifts can still be managed separately if needed.
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    `;
    modal.classList.remove('hidden');
}

function showAllAssignments(user, day, assignments) {
    const assignmentsHTML = assignments.map(assignment => {
        if (assignment.isConsolidated) {
            return `
                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md">
                    <div class="font-medium text-blue-800 dark:text-blue-200">🛡️ Waakdienst (${assignment.shiftCount} shifts)</div>
                    <div class="text-sm text-blue-600 dark:text-blue-400">${formatTime(assignment.start_time)} - ${formatTime(assignment.end_time)}</div>
                </div>
            `;
        } else {
            return `
                <div class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md">
                    <div class="font-medium">${assignment.type}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">${formatTime(assignment.start_time)} - ${formatTime(assignment.end_time)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Status: ${assignment.status || 'Active'}</div>
                </div>
            `;
        }
    }).join('');
    
    const modal = document.getElementById('assignment-modal');
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">All Assignments</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-3 mb-6">
                <div><strong>User:</strong> ${user.name}</div>
                <div><strong>Date:</strong> ${formatDate(day.date)}</div>
                <div><strong>Total Assignments:</strong> ${assignments.length}</div>
            </div>
            
            <div class="space-y-3">
                ${assignmentsHTML}
            </div>
            
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    `;
    modal.classList.remove('hidden');
}

async function deleteAssignment(assignmentId) {
    if (!confirm('Are you sure you want to delete this assignment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/assignments/${assignmentId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
        });
        
        if (response.ok) {
            closeModal();
            loadCalendar(); // Reload calendar to reflect changes
            showNotification('Assignment deleted successfully', 'success');
        } else {
            throw new Error('Failed to delete assignment');
        }
    } catch (error) {
        console.error('Error deleting assignment:', error);
        showNotification('Failed to delete assignment', 'error');
    }
}

async function handleAssignmentMove(dragData, targetUserId, targetDate) {
    console.log('Moving assignment:', dragData, 'to user:', targetUserId, 'date:', targetDate);
    
    if (dragData.userId == targetUserId && dragData.date === targetDate) {
        showNotification('Assignment is already in this location', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/assignments/${dragData.assignmentId}/move/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                new_user_id: targetUserId,
                new_date: targetDate
            })
        });
        
        if (response.ok) {
            loadCalendar(); // Reload to show changes
            showNotification('Assignment moved successfully', 'success');
        } else {
            throw new Error('Failed to move assignment');
        }
    } catch (error) {
        console.error('Error moving assignment:', error);
        showNotification('Failed to move assignment', 'error');
    }
}

function closeModal() {
    const modal = document.getElementById('assignment-modal');
    modal.classList.add('hidden');
    modal.innerHTML = '<div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4"></div>';
}

async function createAssignment(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/api/v1/assignments/quick-create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                user_id: parseInt(formData.get('user_id')),
                date: formData.get('date'),
                assignment_type: formData.get('type'),
                start_time: formData.get('start_time'),
                end_time: formData.get('end_time'),
                team_id: currentTeamId
            })
        });
        
        if (response.ok) {
            closeModal();
            loadCalendar();
            showNotification('Assignment created successfully', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create assignment');
        }
    } catch (error) {
        console.error('Error creating assignment:', error);
        showNotification(`Error: ${error.message}`, 'error');
    }
}

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 DOM loaded, initializing calendar...');
    console.log('🔍 Current team ID:', currentTeamId);
    console.log('🔍 Current date:', currentDate);
    console.log('🔍 Current view:', currentView);
    
    // Check if required elements exist
    const elements = {
        'users-list': document.getElementById('users-list'),
        'days-header': document.getElementById('days-header'),
        'assignments-grid': document.getElementById('assignments-grid'),
        'current-period': document.getElementById('current-period'),
        'view-month': document.getElementById('view-month')
    };
    
    console.log('🔍 Required elements:', elements);
    
    // Check for missing elements
    const missingElements = Object.keys(elements).filter(key => !elements[key]);
    if (missingElements.length > 0) {
        console.error('❌ Missing elements:', missingElements);
    }
    
    // Initialize with month view
    console.log('🚀 Starting initial calendar load...');
    switchView('month');
    
    // Close modal when clicking outside
    document.getElementById('assignment-modal')?.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    
    // Handle window resize for responsive calendar
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            if (calendarData) {
                console.log('📐 Window resized, updating calendar layout...');
                if (currentView === 'week') {
                    renderWeekView();
                } else if (currentView === 'month') {
                    renderCalendar();
                } else if (currentView === 'year') {
                    renderYearView(currentDate.getFullYear());
                }
            }
        }, 300);
    });
});

console.log('📝 New calendar script loaded successfully!');
</script>
{% endblock %}
