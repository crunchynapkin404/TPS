{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
/* Team Detail Specific Styles */
.team-header-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px 0;
    margin-bottom: 32px;
}

.team-badge-large {
    width: 80px;
    height: 80px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 32px;
    color: white;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.team-info-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    padding: 24px;
    margin-bottom: 24px;
}

.dark .team-info-card {
    background: #1f2937;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
}

.members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}

.member-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 20px;
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
}

.dark .member-card {
    background: #1f2937;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    border: 1px solid #374151;
}

.member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.member-avatar-large {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 600;
    color: white;
    margin-bottom: 16px;
}

.role-badge {
    background: #f3f4f6;
    color: #374151;
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 500;
}

.role-badge.lead {
    background: #dbeafe;
    color: #1e40af;
}

.role-badge.coordinator {
    background: #d1fae5;
    color: #065f46;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 20px;
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 12px 16px;
    border-radius: 8px;
    margin: 16px 0;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6b7280;
}

.btn-action {
    background: #3b82f6;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-action:hover {
    background: #2563eb;
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<!-- Team Header Section -->
<div class="team-header-section">
    <div class="container mx-auto px-4">
        <div class="flex items-center">
            <div class="team-badge-large mr-6">
                {{ team.name|first|upper }}
            </div>
            <div>
                <h1 class="text-3xl font-bold mb-2">{{ team.name }}</h1>
                <p class="text-lg opacity-90">{{ team.description|default:"Team Operations" }}</p>
                <div class="flex items-center mt-4 space-x-4">
                    <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm">
                        {{ team.department|default:"General" }}
                    </span>
                    <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm">
                        {% if team.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mx-auto px-4">
    <!-- Team Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="member-count">
                <div class="loading-spinner"></div>
            </div>
            <div class="stat-label">Team Members</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="coverage-percentage">
                <div class="loading-spinner"></div>
            </div>
            <div class="stat-label">Coverage Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="ytd-hours">
                <div class="loading-spinner"></div>
            </div>
            <div class="stat-label">YTD Hours</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="fairness-score">
                <div class="loading-spinner"></div>
            </div>
            <div class="stat-label">Fairness Score</div>
        </div>
    </div>

    <!-- Team Information -->
    <div class="team-info-card">
        <h2 class="section-title mb-4 text-gray-900 dark:text-gray-100">Team Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Team Leader</label>
                <p class="text-gray-900 dark:text-gray-100">{{ team.team_leader.get_full_name|default:"Not assigned" }}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Department</label>
                <p class="text-gray-900 dark:text-gray-100">{{ team.department|default:"General" }}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact Email</label>
                <p class="text-gray-900 dark:text-gray-100">{{ team.contact_email|default:"Not specified" }}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact Phone</label>
                <p class="text-gray-900 dark:text-gray-100">{{ team.contact_phone|default:"Not specified" }}</p>
            </div>
        </div>
    </div>

    <!-- Team Members Section -->
    <div class="mb-8">
        <div class="section-header">
            <h2 class="section-title text-gray-900 dark:text-gray-100">Team Members</h2>
            <a href="#" class="btn-action" id="add-member-btn">Add Member</a>
        </div>
        
        <div id="members-loading" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Loading team members...</p>
        </div>
        
        <div id="members-error" class="error-message" style="display: none;">
            <p>Error loading team members. Please try again.</p>
        </div>
        
        <div id="members-container" class="members-grid" style="display: none;">
            <!-- Members will be loaded here via JavaScript -->
        </div>
        
        <div id="members-empty" class="empty-state" style="display: none;">
            <p>No team members found.</p>
            <a href="#" class="btn-action mt-4">Add First Member</a>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="team-info-card">
        <h2 class="section-title mb-4">Quick Actions</h2>
        <div class="flex flex-wrap gap-4">
            <a href="/teams/{{ team.id }}/schedule/" class="btn-action">View Schedule</a>
            <a href="/teams/{{ team.id }}/workload/" class="btn-action">Workload Analysis</a>
            <a href="/teams/{{ team.id }}/assignments/" class="btn-action">Assignments</a>
            <a href="/teams/" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">Back to Teams</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const teamId = {{ team.id }};
    
    // Load team members
    loadTeamMembers(teamId);
    
    // Load team statistics (if available)
    loadTeamStats(teamId);
});

async function loadTeamMembers(teamId) {
    try {
        const response = await fetch(`/api/v1/teams/${teamId}/members/`, {
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Hide loading
        document.getElementById('members-loading').style.display = 'none';
        
        if (data.success && data.members && data.members.length > 0) {
            displayTeamMembers(data.members);
            
            // Update member count
            document.getElementById('member-count').textContent = data.members.length;
        } else {
            document.getElementById('members-empty').style.display = 'block';
            document.getElementById('member-count').textContent = '0';
        }
    } catch (error) {
        console.error('Error loading team members:', error);
        document.getElementById('members-loading').style.display = 'none';
        document.getElementById('members-error').style.display = 'block';
        document.getElementById('member-count').textContent = '0';
    }
}

function displayTeamMembers(members) {
    const container = document.getElementById('members-container');
    container.innerHTML = '';
    
    members.forEach(member => {
        const memberCard = createMemberCard(member);
        container.appendChild(memberCard);
    });
    
    container.style.display = 'grid';
}

function createMemberCard(member) {
    const card = document.createElement('div');
    card.className = 'member-card';
    
    // Generate avatar color based on name
    const avatarColor = generateAvatarColor(member.first_name + member.last_name);
    const initials = (member.first_name.charAt(0) + member.last_name.charAt(0)).toUpperCase();
    
    card.innerHTML = `
        <div class="flex items-start">
            <div class="member-avatar-large mr-4" style="background: ${avatarColor};">
                ${initials}
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-lg text-gray-900 mb-1">
                    ${member.user_full_name}
                </h3>
                <p class="text-gray-600 text-sm mb-3">${member.email}</p>
                <div class="flex items-center justify-between">
                    <span class="role-badge ${getRoleBadgeClass(member.role.name)}">
                        ${member.role.name}
                    </span>
                    <span class="text-xs text-gray-500">
                        Joined: ${member.join_date}
                    </span>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

function generateAvatarColor(name) {
    const colors = [
        '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
        '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1'
    ];
    
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    return colors[Math.abs(hash) % colors.length];
}

function getRoleBadgeClass(roleName) {
    switch(roleName.toLowerCase()) {
        case 'lead':
        case 'team_lead':
        case 'deputy_lead':
            return 'lead';
        case 'coordinator':
        case 'team_coordinator':
            return 'coordinator';
        default:
            return '';
    }
}

async function loadTeamStats(teamId) {
    try {
        // You can implement additional API calls here for team statistics
        // For now, we'll set some default values
        document.getElementById('coverage-percentage').textContent = '85%';
        document.getElementById('ytd-hours').textContent = '2,450';
        document.getElementById('fairness-score').textContent = '8.2';
    } catch (error) {
        console.error('Error loading team stats:', error);
        document.getElementById('coverage-percentage').textContent = 'N/A';
        document.getElementById('ytd-hours').textContent = 'N/A';
        document.getElementById('fairness-score').textContent = 'N/A';
    }
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}
